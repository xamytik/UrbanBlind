<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>UrbanBlind - –ê–Ω–∞–ª–∏–∑ —Ä–∏—Å–∫–æ–≤ –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
:root {
--glass-bg: rgba(255, 255, 255, 0.85);
--glass-border: rgba(0, 0, 0, 0.08);
--glass-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
--glass-blur: blur(12px);
--primary-color: #34495e;
--secondary-color: #2c3e50;
--accent-blue: #3498db;
--accent-orange: #e67e22;
--accent-purple: #9b59b6;
--accent-green: #27ae60;
--text-primary: #2c3e50;
--text-secondary: #7f8c8d;
--text-muted: #95a5a6;
--noise-color: #f39c12;
--crowd-color: #9b59b6;
--light-color: #3498db;
--time-color: #1abc9c;
--day-color: #e67e22;
}
body { display: flex; height: 100vh; overflow: hidden; background: linear-gradient(135deg, #f5f7fa 0%, #e4e7eb 100%); width: 100vw; }
#ub-logo {
position: fixed; top: 5px; left: 40px; font-size: 28px; font-weight: 800;
color: var(--secondary-color); z-index: 100; text-shadow: 0 2px 4px rgba(0,0,0,0.05);
letter-spacing: -1px; background: #ffffff; border-radius: 12px;
padding: 5px 16px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
border: 1px solid rgba(0, 0, 0, 0.08); transition: all 0.3s ease;
}
#ub-logo:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15); }
#map { flex: 2; height: 100%; min-width: 0; position: relative; background: #e8eaed; }
#map-error {
position: absolute; top: 0; left: 0; right: 0; bottom: 0;
background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%);
color: white; display: none; flex-direction: column;
align-items: center; justify-content: center; text-align: center;
padding: 20px; z-index: 1000; animation: fadeIn 0.5s ease;
}
#map-error.visible { display: flex; }
#map-error h2 { margin-bottom: 15px; font-size: 24px; }
#map-error p { margin-bottom: 20px; max-width: 400px; line-height: 1.6; }
#map-error button {
padding: 12px 24px; background: rgba(255, 255, 255, 0.15);
color: white; border: 1px solid rgba(255, 255, 255, 0.3);
border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px;
transition: all 0.3s ease;
}
#map-error button:hover { background: rgba(255, 255, 255, 0.25); transform: translateY(-2px); }
#sidebar {
flex: 1; background: var(--glass-bg); backdrop-filter: var(--glass-blur);
-webkit-backdrop-filter: var(--glass-blur); padding: 20px;
overflow-y: auto; box-shadow: var(--glass-shadow);
max-width: 500px; display: flex; flex-direction: column;
z-index: 10; min-width: 350px; position: relative;
}
.instructions-container {
position: sticky; top: 0; z-index: 100; background: var(--glass-bg);
backdrop-filter: var(--glass-blur); -webkit-backdrop-filter: var(--glass-blur);
border-radius: 12px; margin: -20px -20px 20px -20px;
padding: 15px 20px; box-shadow: var(--glass-shadow);
}
.instructions {
background: rgba(238, 247, 255, 0.7); border-left: 4px solid var(--accent-blue);
padding: 12px; border-radius: 0 4px 4px 0; font-size: 13px; color: var(--text-primary);
}
.instructions h3 { font-weight: 600; margin-bottom: 8px; color: var(--secondary-color); display: flex; align-items: center; gap: 8px; }
.instructions ul { padding-left: 20px; }
.instructions li { margin-bottom: 5px; line-height: 1.4; }
.sidebar-header {
margin-bottom: 20px; padding-bottom: 15px;
border-bottom: 1px solid var(--glass-border);
position: sticky; top: 0; background: var(--glass-bg); z-index: 100;
}
h1 { font-size: 20px; color: var(--secondary-color); margin-bottom: 5px; font-weight: 600; }
.subtitle { color: var(--text-muted); font-size: 12px; font-weight: 500; }
.api-status {
display: flex; align-items: center; font-size: 11px;
color: var(--text-muted); margin-top: 12px; flex-wrap: wrap;
gap: 8px; background: rgba(0, 0, 0, 0.03); padding: 8px 12px; border-radius: 8px;
}
.status-dot { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 4px; }
.status-good { background-color: var(--accent-green); }
.status-warning { background-color: var(--accent-orange); }
.status-error { background-color: #e74c3c; }
.card {
background: #fff; border-radius: 12px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
padding: 20px; margin-bottom: 20px; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
position: relative; overflow: hidden;
}
.card:hover { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1); }
.card-title { display: flex; align-items: center; margin-bottom: 15px; color: var(--text-primary); font-weight: 600; font-size: 18px; }
.card-title .icon { margin-right: 10px; font-size: 20px; }
.data-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid rgba(0, 0, 0, 0.05); transition: all 0.3s ease; }
.data-row:hover { background: rgba(0, 0, 0, 0.02); padding-left: 10px; }
.data-row:last-child { border-bottom: none; }
.data-label { color: var(--text-muted); font-weight: 500; }
.data-value { font-weight: 600; color: var(--text-primary); }
.safety-index { padding: 18px; border-radius: 10px; margin-bottom: 15px; position: relative; overflow: hidden; }
.safety-index-title { font-size: 13px; opacity: 0.8; margin-bottom: 5px; position: relative; z-index: 1; }
.safety-index-value { font-size: 40px; font-weight: 800; position: relative; z-index: 1; text-shadow: 0 2px 4px rgba(0,0,0,0.2); }
.safety-index-label { font-size: 12px; opacity: 0.9; margin-top: 5px; position: relative; z-index: 1; }
.risk-grid { display: grid; grid-template-columns: 1fr; gap: 15px; }
.risk-item {
background: #fafbfc; padding: 15px; border-radius: 10px;
border-left: 4px solid var(--glass-border);
transition: all 0.3s ease; position: relative; overflow: hidden;
}
.risk-item:hover { transform: translateX(3px); background: #f8f9fa; }
.risk-item.noise { border-left-color: var(--noise-color); }
.risk-item.crowd { border-left-color: var(--crowd-color); }
.risk-item.light { border-left-color: var(--light-color); }
.risk-item.time { border-left-color: var(--time-color); }
.risk-item.day { border-left-color: var(--day-color); }
.risk-item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
.risk-item-title { font-weight: 600; font-size: 14px; color: var(--text-primary); }
.risk-item-icon { font-size: 18px; opacity: 0.7; }
.risk-indicator { display: flex; align-items: center; gap: 10px; margin-top: 5px; }
.risk-bar { flex: 1; height: 8px; background: rgba(0, 0, 0, 0.05); border-radius: 4px; overflow: hidden; position: relative; }
.risk-fill { height: 100%; border-radius: 4px; transition: width 0.8s cubic-bezier(0.25, 0.8, 0.25, 1), background 0.5s ease; position: relative; overflow: hidden; }
.risk-low { background: var(--accent-green); box-shadow: 0 2px 8px rgba(39, 174, 96, 0.2); }
.risk-medium { background: var(--accent-orange); box-shadow: 0 2px 8px rgba(230, 126, 34, 0.2); }
.risk-high { background: #e74c3c; box-shadow: 0 2px 8px rgba(231, 76, 60, 0.2); }
.risk-value { min-width: 50px; text-align: right; font-weight: 600; font-size: 14px; color: var(--text-primary); transition: all 0.3s ease; }
.traffic-low { background: #d4edda; color: #155724; padding: 3px 8px; border-radius: 15px; font-weight: 600; font-size: 13px; display: inline-block; }
.traffic-medium { background: #fff3cd; color: #856404; padding: 3px 8px; border-radius: 15px; font-weight: 600; font-size: 13px; display: inline-block; }
.traffic-high { background: #f8d7da; color: #721c24; padding: 3px 8px; border-radius: 15px; font-weight: 600; font-size: 13px; display: inline-block; }
.loader { text-align: center; padding: 15px; color: var(--text-muted); font-style: italic; display: none; background: rgba(0, 0, 0, 0.02); border-radius: 8px; margin-bottom: 15px; }
.loader.active { display: block; }
.loader::before { content: 'üîÑ'; display: inline-block; animation: spin 1.2s linear infinite; margin-right: 8px; }
.btn-save { padding: 8px 16px; background: var(--accent-blue); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; margin-top: 12px; transition: all 0.3s ease; width: 100%; }
.btn-save:hover { background: #2980b9; transform: translateY(-1px); }
.btn-refresh { padding: 5px 10px; background: var(--accent-purple); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; margin-left: 8px; transition: all 0.2s ease; }
.btn-refresh:hover { background: #8e44ad; transform: scale(1.05); }
footer { margin-top: auto; padding-top: 15px; border-top: 1px solid var(--glass-border); font-size: 11px; color: var(--text-muted); text-align: center; }
.demo-mode-badge {
background: #fff3cd; color: #856404; padding: 4px 8px; border-radius: 4px;
font-size: 10px; font-weight: bold; margin-left: auto; border: 1px solid #ffeeba;
}
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: #f1f1f1; }
::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: #a1a1a1; }
@media (max-width: 768px) {
body { flex-direction: column; }
#map { flex: 1; height: 50vh; min-height: 300px; }
#sidebar { flex: 1; height: 50vh; max-width: 100%; min-width: 0; }
.safety-index-value { font-size: 32px; }
}
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
@keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
</style>
</head>
<body>
<div id="ub-logo">UrbanBlind</div>
<div id="map">
<div id="map-error">
<h2>üó∫Ô∏è –ö–∞—Ä—Ç–∞ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–∞—Å—å</h2>
<p>–í–æ–∑–º–æ–∂–Ω–æ, –ø—Ä–æ–±–ª–µ–º–∞ —Å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–æ–º –∏–ª–∏ API –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç.</p>
<p><strong>–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Ü–µ–Ω—Ç—Ä–∞ –ö–∞–∑–∞–Ω–∏:</strong><br>55.7961, 49.1064</p>
<button onclick="location.reload()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É</button>
</div>
</div>
<div id="sidebar">
<div class="instructions-container">
<div class="instructions">
<h3>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é</h3>
<ul>
<li>üéØ <strong>–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –º–∞—Ä–∫–µ—Ä</strong> ‚Äî –¥–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤—è—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</li>
<li>üñ±Ô∏è <strong>–ö–ª–∏–∫ –ø–æ –∫–∞—Ä—Ç–µ</strong> ‚Äî –º–≥–Ω–æ–≤–µ–Ω–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥ –∫ —Ç–æ—á–∫–µ</li>
<li>üìä <strong>–§–∞–∫—Ç–æ—Ä—ã —Ä–∏—Å–∫–∞</strong> ‚Äî —à—É–º, –ø–ª–æ—Ç–Ω–æ—Å—Ç—å –ª—é–¥–µ–π, –æ—Å–≤–µ—â–µ–Ω–Ω–æ—Å—Ç—å</li>
<li>üå§Ô∏è <strong>–ü–æ–≥–æ–¥–∞</strong> ‚Äî —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</li>
<li>üö¶ <strong>–ü—Ä–æ–±–∫–∏</strong> ‚Äî –¥–∞–Ω–Ω—ã–µ –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç</li>
</ul>
</div>
</div>
<div class="sidebar-header">
<h1>UrbanBlind</h1>
<div class="subtitle">–§–∞–∫—Ç–æ—Ä—ã —Ä–∏—Å–∫–∞ ‚Ä¢ –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å ‚Ä¢ –ê–Ω–∞–ª–∏—Ç–∏–∫–∞</div>
<div class="api-status">
<span class="status-dot status-warning" id="server-dot"></span>
<span id="server-text">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...</span>
<button id="btn-force-refresh" class="btn-refresh" title="–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å">üîÑ</button>
</div>
</div>
<div id="loader" class="loader">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏ —Ä–∞—Å—á—ë—Ç —Ñ–∞–∫—Ç–æ—Ä–æ–≤ —Ä–∏—Å–∫–∞...</div>
<div id="content">
<div class="card">
<div class="card-title"><span class="icon">üõ°Ô∏è</span>–ò–Ω–¥–µ–∫—Å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏</div>
<div class="safety-index" id="safety-index-card">
<div class="safety-index-title">–û–±—â–∏–π —É—Ä–æ–≤–µ–Ω—å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏</div>
<div class="safety-index-value" id="safety-index-value">--</div>
<div class="safety-index-label" id="safety-index-label">–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç–µ –º–∞—Ä–∫–µ—Ä –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞</div>
</div>
<div class="location-info" id="coords-display">–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: 55.7961, 49.1064</div>
</div>
<div class="card">
<div class="card-title"><span class="icon">‚ö†Ô∏è</span>–§–∞–∫—Ç–æ—Ä—ã —Ä–∏—Å–∫–∞</div>
<div class="risk-grid">
<div class="risk-item noise">
<div class="risk-item-header">
<span class="risk-item-title">üîä –®—É–º –æ–∫—Ä—É–∂–∞—é—â–µ–π —Å—Ä–µ–¥—ã</span>
<span class="risk-item-icon">üì¢</span>
</div>
<div class="risk-indicator">
<div class="risk-bar"><div class="risk-fill risk-low" id="noise-bar" style="width: 0%"></div></div>
<span class="risk-value" id="noise-value">--</span>
</div>
<div style="font-size:11px;color:var(--text-muted);margin-top:5px" id="noise-desc">–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è...</div>
</div>
<div class="risk-item crowd">
<div class="risk-item-header">
<span class="risk-item-title">üë• –ü–ª–æ—Ç–Ω–æ—Å—Ç—å –ª—é–¥–µ–π</span>
<span class="risk-item-icon">üö∂</span>
</div>
<div class="risk-indicator">
<div class="risk-bar"><div class="risk-fill risk-low" id="crowd-bar" style="width: 0%"></div></div>
<span class="risk-value" id="crowd-value">--</span>
</div>
<div style="font-size:11px;color:var(--text-muted);margin-top:5px" id="crowd-desc">–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è...</div>
</div>
<div class="risk-item light">
<div class="risk-item-header">
<span class="risk-item-title">üí° –û—Å–≤–µ—â–µ–Ω–Ω–æ—Å—Ç—å</span>
<span class="risk-item-icon">üåô</span>
</div>
<div class="risk-indicator">
<div class="risk-bar"><div class="risk-fill risk-low" id="light-bar" style="width: 0%"></div></div>
<span class="risk-value" id="light-value">--</span>
</div>
<div style="font-size:11px;color:var(--text-muted);margin-top:5px" id="light-desc">–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è...</div>
</div>
<div class="risk-item time">
<div class="risk-item-header">
<span class="risk-item-title">üïê –í—Ä–µ–º—è —Å—É—Ç–æ–∫</span>
<span class="risk-item-icon">‚è∞</span>
</div>
<div class="risk-indicator">
<div class="risk-bar"><div class="risk-fill risk-low" id="time-bar" style="width: 0%"></div></div>
<span class="risk-value" id="time-value">--</span>
</div>
<div style="font-size:11px;color:var(--text-muted);margin-top:5px" id="time-desc">–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è...</div>
</div>
<div class="risk-item day">
<div class="risk-item-header">
<span class="risk-item-title">üìÖ –î–µ–Ω—å –Ω–µ–¥–µ–ª–∏</span>
<span class="risk-item-icon">üìÜ</span>
</div>
<div class="risk-indicator">
<div class="risk-bar"><div class="risk-fill risk-low" id="day-bar" style="width: 0%"></div></div>
<span class="risk-value" id="day-value">--</span>
</div>
<div style="font-size:11px;color:var(--text-muted);margin-top:5px" id="day-desc">–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è...</div>
</div>
</div>
</div>
<div class="card">
<div class="card-title"><span class="icon">üå§Ô∏è</span>–ü–æ–≥–æ–¥–∞</div>
<div class="data-row"><span class="data-label">–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞:</span><span class="data-value" id="w-temp">‚Äî</span></div>
<div class="data-row"><span class="data-label">–°–æ—Å—Ç–æ—è–Ω–∏–µ:</span><span class="data-value" id="w-cond">‚Äî</span></div>
<div class="data-row"><span class="data-label">–í–µ—Ç–µ—Ä:</span><span class="data-value" id="w-wind">‚Äî</span></div>
<div class="data-row"><span class="data-label">–í–ª–∞–∂–Ω–æ—Å—Ç—å:</span><span class="data-value" id="w-hum">‚Äî</span></div>
</div>
<div class="card">
<div class="card-title"><span class="icon">üöó</span>–ü—Ä–æ–±–∫–∏</div>
<div class="data-row"><span class="data-label">–£—Ä–æ–≤–µ–Ω—å:</span><span class="data-value" id="t-level">‚Äî</span></div>
<div class="data-row"><span class="data-label">–°—Ç–∞—Ç—É—Å:</span><span class="data-value" id="t-status">‚Äî</span></div>
</div>
</div>
<footer>
<p>UrbanBlind ¬© 2026 | Yandex Maps ‚Ä¢ OpenStreetMap ‚Ä¢ Open-Meteo ‚Ä¢ TomTom</p>
<p style="font-size:10px;margin-top:5px;color:var(--text-muted)">–•–∞–∫–∞—Ç–æ–Ω ¬´–£–º–Ω—ã–π –≥–æ—Ä–æ–¥¬ª ‚Äî –ê–Ω–∞–ª–∏–∑ —Ñ–∞–∫—Ç–æ—Ä–æ–≤ —Ä–∏—Å–∫–∞</p>
</footer>
</div>
<!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç -->
<script src="https://api-maps.yandex.ru/2.1/?apikey=c2763cd1-5a14-4131-842c-2bbd60932c52&lang=ru_RU" type="text/javascript"></script>
<script>
// --- –ù–ê–°–¢–†–û–ô–ö–ò ---
const CONFIG = {
    throttleMs: 600,
    minDragDistance: 0.001,
    defaultCoords: [55.7961, 49.1064],
    debugMode: false,
    overpassUrl: 'https://overpass-api.de/api/interpreter',
    openMeteoUrl: 'https://api.open-meteo.com/v1/forecast',
    sunriseUrl: 'https://api.sunrise-sunset.org/json',
    overpassTimeout: 25,
    cacheDuration: 300000, // 5 –º–∏–Ω—É—Ç
    fallbackRadius: 200 // –†–∞–¥–∏—É—Å –¥–ª—è OSM fallback'–æ–≤ –≤ –º–µ—Ç—Ä–∞—Ö
};

// --- –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ---
let map, placemark;
let currentCoords = [...CONFIG.defaultCoords];
let lastRequestTime = 0;
let lastRequestCoords = null;
let isDragging = false;
let pendingRequest = null;
let mapInitialized = false;
let apiCache = new Map();

// --- –£–¢–ò–õ–ò–¢–´ ---
function throttle(func, limitMs) {
    return function(...args) {
        const now = Date.now();
        const coords = args[0];
        if (lastRequestCoords) {
            const dist = Math.hypot(coords[0] - lastRequestCoords[0], coords[1] - lastRequestCoords[1]);
            if (dist < CONFIG.minDragDistance && now - lastRequestTime < limitMs * 2) {
                return;
            }
        }
        if (now - lastRequestTime >= limitMs) {
            lastRequestTime = now;
            lastRequestCoords = [...coords];
            func.apply(this, args);
        } else {
            if (pendingRequest) clearTimeout(pendingRequest);
            pendingRequest = setTimeout(() => {
                lastRequestTime = Date.now();
                lastRequestCoords = [...coords];
                func.apply(this, args);
                pendingRequest = null;
            }, limitMs - (now - lastRequestTime));
        }
    };
}

function formatCoord(val) { return val.toFixed(4); }

function getCachedData(key) {
    const cached = apiCache.get(key);
    if (cached && Date.now() - cached.time < CONFIG.cacheDuration) {
        return cached.data;
    }
    return null;
}

function setCachedData(key, data) {
    apiCache.set(key, { data, time: Date.now() });
}

// --- –ü–û–ì–û–î–ê (Open-Meteo) ---
async function getWeatherFromOpenMeteo(lat, lon) {
    const cacheKey = `weather:${lat.toFixed(2)},${lon.toFixed(2)}`;
    const cached = getCachedData(cacheKey);
    if (cached) {
        if (CONFIG.debugMode) console.log("Weather cache hit:", cacheKey);
        return cached;
    }
    try {
        const url = `${CONFIG.openMeteoUrl}?latitude=${lat}&longitude=${lon}&current_weather=true&hourly=relative_humidity_2m&timezone=auto`;
        if (CONFIG.debugMode) console.log("Fetching weather from:", url);

        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 10000);

        const response = await fetch(url, {
            method: 'GET',
            headers: { 'Accept': 'application/json' },
            signal: controller.signal
        });

        clearTimeout(timeoutId);

        if (!response.ok) {
            throw new Error(`HTTP ${response.status} ${response.statusText}`);
        }

        const data = await response.json();
        if (!data.current_weather) {
            throw new Error('No current_weather data received');
        }

        let humidity = 'N/A';
        if (data.hourly?.relative_humidity_2m && data.hourly.time) {
            const now = new Date();
            const currentTimeISO = now.toISOString().split(':')[0] + ':00';
            const index = data.hourly.time.findIndex(time => time.startsWith(currentTimeISO));
            humidity = index !== -1 ? data.hourly.relative_humidity_2m[index] : data.hourly.relative_humidity_2m[0];
        }

        const weather = {
            temp: data.current_weather.temperature ?? 'N/A',
            wind: `${data.current_weather.windspeed ?? 'N/A'} km/h`,
            wind_direction: data.current_weather.winddirection,
            humidity: humidity,
            condition: getWeatherCondition(data.current_weather.weathercode)
        };

        if (CONFIG.debugMode) console.log("Weather fetched:", weather);
        setCachedData(cacheKey, weather);
        return weather;
    } catch (error) {
        console.error("Open-Meteo Weather API Error:", error);
        updateStatus('warning', '–ü–æ–≥–æ–¥–∞: –æ—à–∏–±–∫–∞ API');
        // Fallback
        return { temp: '20¬∞C', wind: '3 km/h', humidity: '60%', condition: '–Ø—Å–Ω–æ (Fallback)' };
    }
}

function getWeatherCondition(code) {
    const conditions = {
        0: '‚òÄÔ∏è –Ø—Å–Ω–æ', 1: 'üå§Ô∏è –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–µ–Ω–Ω–æ —è—Å–Ω–æ', 2: '‚õÖ –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–±–ª–∞—á–Ω–æ—Å—Ç—å',
        3: '‚òÅÔ∏è –ü–∞—Å–º—É—Ä–Ω–æ', 45: 'üå´Ô∏è –¢—É–º–∞–Ω', 48: '‚ùÑÔ∏è –ò–Ω–µ–π',
        51: 'üíß –ú–æ—Ä–æ—Å—å', 53: 'üíß –ú–æ—Ä–æ—Å—å', 55: 'üíß –ú–æ—Ä–æ—Å—å',
        61: 'üåßÔ∏è –î–æ–∂–¥—å', 63: 'üåßÔ∏è –î–æ–∂–¥—å', 65: 'üåßÔ∏è –°–∏–ª—å–Ω—ã–π –¥–æ–∂–¥—å',
        71: '‚ùÑÔ∏è –°–Ω–µ–≥', 73: '‚ùÑÔ∏è –°–Ω–µ–≥', 75: '‚ùÑÔ∏è –°–∏–ª—å–Ω—ã–π —Å–Ω–µ–≥',
        80: 'üå¶Ô∏è –õ–∏–≤–µ–Ω—å', 81: 'üå¶Ô∏è –õ–∏–≤–µ–Ω—å', 82: 'üå¶Ô∏è –°–∏–ª—å–Ω—ã–π –ª–∏–≤–µ–Ω—å',
        95: '‚õàÔ∏è –ì—Ä–æ–∑–∞', 96: '‚õàÔ∏è –ì—Ä–æ–∑–∞ —Å –≥—Ä–∞–¥–æ–º', 99: '‚õàÔ∏è –°–∏–ª—å–Ω–∞—è –≥—Ä–æ–∑–∞'
    };
    return conditions[code] || `‚ùì ${code}`;
}

// --- –ü–†–û–ë–ö–ò (FAKE/OSM-BASED FALLBACK) ---
async function getTrafficFromFallback(lat, lon) {
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ —Ñ–æ–ª–ª–±—ç–∫ –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤—Ä–µ–º–µ–Ω–∏ —Å—É—Ç–æ–∫
    const hour = new Date().getHours();
    let level, status, speed_avg;

    if ((hour >= 7 && hour < 10) || (hour >= 17 && hour < 20)) {
        level = 8;
        status = '–ü–∏–∫–æ–≤—ã–µ —á–∞—Å—ã (–í—ã—Å–æ–∫–∞—è –∑–∞–≥—Ä.)';
        speed_avg = '~15 –∫–º/—á';
    } else if (hour >= 10 && hour < 17) {
        level = 4;
        status = '–î–Ω–µ–≤–Ω–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å';
        speed_avg = '~40 –∫–º/—á';
    } else {
        level = 2;
        status = '–ù–æ—á–Ω–∞—è —Ç–∏—à–∏–Ω–∞';
        speed_avg = '~60 –∫–º/—á';
    }

    const trafficData = {
        level: level,
        status: status,
        speed_avg: speed_avg,
        source: 'fallback'
    };

    if (CONFIG.debugMode) console.log("Traffic (fallback) generated:", trafficData);
    return trafficData;
}

// --- –®–£–ú (OSM-BASED) ---
async function getNoiseFromOsmBased(lat, lon) {
    const cacheKey = `noise_osm_based:${lat.toFixed(4)},${lon.toFixed(4)}`;
    const cached = getCachedData(cacheKey);
    if (cached) {
        if (CONFIG.debugMode) console.log("Noise OSM-based cache hit:", cacheKey);
        return cached;
    }

    try {
        const radius = CONFIG.fallbackRadius;
        // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–∞—Ñ–µ, –±–∞—Ä–æ–≤, —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤, –∑–∞–ø—Ä–∞–≤–æ–∫, –¥–æ—Ä–æ–≥ –≤ —Ä–∞–¥–∏—É—Å–µ
        const query = `[out:json][timeout:${CONFIG.overpassTimeout}];(node["amenity"~"cafe|bar|pub|fast_food|restaurant|fuel"](around:${radius},${lat},${lon});way["highway"~"primary|secondary|tertiary|residential"](around:${radius},${lat},${lon}););out count;`;
        if (CONFIG.debugMode) console.log("Fetching noise from OSM with query:", query);

        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 10000);

        const response = await fetch(CONFIG.overpassUrl, {
            method: 'POST',
            body: `data=${encodeURIComponent(query)}`,
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            signal: controller.signal
        });

        clearTimeout(timeoutId);

        if (!response.ok) throw new Error(`Overpass HTTP ${response.status}`);

        const data = await response.json();
        const count = data.elements?.length || 0;

        let level, risk, desc;
        if (count > 40) { level = 75; risk = 80; desc = '–û—á–µ–Ω—å —à—É–º–Ω–æ (OSM-Based)'; }
        else if (count > 25) { level = 65; risk = 65; desc = '–®—É–º–Ω–æ (OSM-Based)'; }
        else if (count > 15) { level = 55; risk = 45; desc = '–£–º–µ—Ä–µ–Ω–Ω—ã–π —à—É–º (OSM-Based)'; }
        else if (count > 5) { level = 45; risk = 30; desc = '–¢–∏—Ö–æ (OSM-Based)'; }
        else { level = 35; risk = 15; desc = '–û—á–µ–Ω—å —Ç–∏—Ö–æ (OSM-Based)'; }

        const result = { level: level, risk: risk, desc: desc, source: 'osm_based' };
        if (CONFIG.debugMode) console.log("Noise OSM-based result:", result);
        setCachedData(cacheKey, result);
        return result;
    } catch (error) {
        console.error("OSM-based Noise Error:", error);
        // –§–∏–Ω–∞–ª—å–Ω—ã–π —Ñ–æ–ª–ª–±—ç–∫
        const finalFallback = { level: 50, risk: 40, desc: 'Fallback (Error)', source: 'fallback_final' };
        setCachedData(cacheKey, finalFallback);
        return finalFallback;
    }
}

// --- –ü–õ–û–¢–ù–û–°–¢–¨ –õ–Æ–î–ï–ô (OSM-BASED) ---
async function getCrowdFromOsmBased(lat, lon) {
    const cacheKey = `crowd_osm_based:${lat.toFixed(4)},${lon.toFixed(4)}`;
    const cached = getCachedData(cacheKey);
    if (cached) {
        if (CONFIG.debugMode) console.log("Crowd OSM-based cache hit:", cacheKey);
        return cached;
    }

    try {
        const radius = CONFIG.fallbackRadius;
        // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–∞—Ñ–µ, —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤, –º–∞–≥–∞–∑–∏–Ω–æ–≤, –∞–≤—Ç–æ–±—É—Å–Ω—ã—Ö –æ—Å—Ç–∞–Ω–æ–≤–æ–∫, —Å—Ç–∞–Ω—Ü–∏–π
        const query = `[out:json][timeout:${CONFIG.overpassTimeout}];(node["amenity"~"cafe|restaurant|bar|pub|fast_food|fuel|bank|post_office"](around:${radius},${lat},${lon});node["shop"](around:${radius},${lat},${lon});node["highway"="bus_stop"](around:${radius},${lat},${lon});node["public_transport"="station"](around:${radius},${lat},${lon}););out count;`;
        if (CONFIG.debugMode) console.log("Fetching crowd from OSM with query:", query);

        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 10000);

        const response = await fetch(CONFIG.overpassUrl, {
            method: 'POST',
            body: `data=${encodeURIComponent(query)}`,
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            signal: controller.signal
        });

        clearTimeout(timeoutId);

        if (!response.ok) throw new Error(`Overpass HTTP ${response.status}`);

        const data = await response.json();
        const count = data.elements?.length || 0;

        let level, risk, desc;
        if (count > 50) { level = 90; risk = 85; desc = '–û—á–µ–Ω—å –≤—ã—Å–æ–∫–∞—è –ø–ª–æ—Ç–Ω–æ—Å—Ç—å (OSM-Based)'; }
        else if (count > 30) { level = 70; risk = 65; desc = '–í—ã—Å–æ–∫–∞—è –ø–ª–æ—Ç–Ω–æ—Å—Ç—å (OSM-Based)'; }
        else if (count > 15) { level = 50; risk = 45; desc = '–°—Ä–µ–¥–Ω—è—è –ø–ª–æ—Ç–Ω–æ—Å—Ç—å (OSM-Based)'; }
        else if (count > 5) { level = 30; risk = 25; desc = '–ù–∏–∑–∫–∞—è –ø–ª–æ—Ç–Ω–æ—Å—Ç—å (OSM-Based)'; }
        else { level = 15; risk = 15; desc = '–û—á–µ–Ω—å –Ω–∏–∑–∫–∞—è –ø–ª–æ—Ç–Ω–æ—Å—Ç—å (OSM-Based)'; }

        const result = { level: level, risk: risk, desc: desc, source: 'osm_based' };
        if (CONFIG.debugMode) console.log("Crowd OSM-based result:", result);
        setCachedData(cacheKey, result);
        return result;
    } catch (error) {
        console.error("OSM-based Crowd Error:", error);
        // –§–∏–Ω–∞–ª—å–Ω—ã–π —Ñ–æ–ª–ª–±—ç–∫
        const finalFallback = { level: 35, risk: 25, desc: 'Fallback (Error)', source: 'fallback_final' };
        setCachedData(cacheKey, finalFallback);
        return finalFallback;
    }
}

// --- –û–°–í–ï–©–ï–ù–ù–û–°–¢–¨ (Sunrise-Sunset + OSM Lamps) ---
async function getLightFromSunriseAndOsm(lat, lon) {
    const cacheKey = `light_sunrise_osm:${lat.toFixed(4)},${lon.toFixed(4)}`;
    const cached = getCachedData(cacheKey);
    if (cached) {
        if (CONFIG.debugMode) console.log("Light (Sunrise+OSM) cache hit:", cacheKey);
        return cached;
    }
    try {
        const timeInfo = await getTimeOfDayByLocation(lat, lon);
        if (timeInfo.isDaytime) {
            const result = {
                level: 95,
                risk: 10,
                desc: '–ï—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ –æ—Å–≤–µ—â–µ–Ω–∏–µ (–¥–µ–Ω—å)',
                source: 'time_day'
            };
            if (CONFIG.debugMode) console.log("Light (daytime) result:", result);
            setCachedData(cacheKey, result);
            return result;
        }

        // –ó–∞–ø—Ä–æ—Å –ª–∞–º–ø–æ—á–µ–∫ –Ω–æ—á—å—é –∏–∑ OSM
        const radius = CONFIG.fallbackRadius;
        const query = `[out:json][timeout:${CONFIG.overpassTimeout}];(node["highway"="street_lamp"](around:${radius},${lat},${lon});node["man_made"="street_lamp"](around:${radius},${lat},${lon}););out count;`;
        if (CONFIG.debugMode) console.log("Fetching light from OSM with query:", query);

        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 10000);

        const response = await fetch(CONFIG.overpassUrl, {
            method: 'POST',
            body: `data=${encodeURIComponent(query)}`,
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            signal: controller.signal
        });

        clearTimeout(timeoutId);

        if (!response.ok) throw new Error(`Overpass HTTP ${response.status}`);

        const data = await response.json();
        const count = data.elements?.length || 0;

        let level, risk, desc;
        if (count > 20) { level = 85; risk = 15; desc = '–û—Ç–ª–∏—á–Ω–æ–µ –æ—Å–≤–µ—â–µ–Ω–∏–µ'; }
        else if (count > 10) { level = 65; risk = 35; desc = '–•–æ—Ä–æ—à–µ–µ –æ—Å–≤–µ—â–µ–Ω–∏–µ'; }
        else if (count > 3) { level = 45; risk = 55; desc = '–°—Ä–µ–¥–Ω–µ–µ –æ—Å–≤–µ—â–µ–Ω–∏–µ'; }
        else { level = 25; risk = 70; desc = '–°–ª–∞–±–æ–µ –æ—Å–≤–µ—â–µ–Ω–∏–µ'; }

        const result = { level: level, risk: risk, desc: desc, source: 'osm_lamps' };
        if (CONFIG.debugMode) console.log("Light (night, OSM lamps) result:", result);
        setCachedData(cacheKey, result);
        return result;
    } catch (error) {
        console.error("OSM-based Light Error:", error);
        // –§–∏–Ω–∞–ª—å–Ω—ã–π —Ñ–æ–ª–ª–±—ç–∫
        const finalFallback = { level: 40, risk: 50, desc: 'Fallback (Error)', source: 'fallback_final' };
        setCachedData(cacheKey, finalFallback);
        return finalFallback;
    }
}

// --- –í–†–ï–ú–Ø –°–£–¢–û–ö ---
async function getSunriseSunset(lat, lon) {
    const cacheKey = `sunrise:${lat.toFixed(4)},${lon.toFixed(4)}`;
    const cached = getCachedData(cacheKey);
    if (cached) {
        if (CONFIG.debugMode) console.log("Sunrise cache hit:", cacheKey);
        return cached;
    }
    try {
        const url = `${CONFIG.sunriseUrl}?lat=${lat}&lng=${lon}&date=today&formatted=0`;
        if (CONFIG.debugMode) console.log("Fetching sunrise/sunset from:", url);

        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 5000);

        const response = await fetch(url, { signal: controller.signal });

        clearTimeout(timeoutId);

        if (!response.ok) throw new Error(`Sunrise API HTTP ${response.status}`);

        const data = await response.json();
        if (!data.results?.sunrise) throw new Error('Invalid response from sunrise API');

        const result = {
            sunrise: new Date(data.results.sunrise),
            sunset: new Date(data.results.sunset)
        };

        if (CONFIG.debugMode) console.log("Sunrise/sunset fetched:", result);
        setCachedData(cacheKey, result);
        return result;
    } catch (error) {
        console.error("Sunrise/Sunset API Error:", error);
        // –ù–µ –∫—ç—à–∏—Ä—É–µ–º –æ—à–∏–±–∫—É, —á—Ç–æ–±—ã –ø–æ–≤—Ç–æ—Ä—è—Ç—å –ø–æ–ø—ã—Ç–∫–∏
        return null;
    }
}

async function getTimeOfDayByLocation(lat, lon) {
    const now = new Date();
    const sunData = await getSunriseSunset(lat, lon);
    const hour = now.getHours();

    if (!sunData) {
        // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ç–æ—á–Ω–æ–µ –≤—Ä–µ–º—è, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω–æ–µ
        const isDaytime = hour >= 6 && hour < 22; // –ì—Ä—É–±–∞—è –æ—Ü–µ–Ω–∫–∞
        let timeOfDay = '–ù–æ—á—å';
        if (hour >= 5 && hour < 12) timeOfDay = '–£—Ç—Ä–æ';
        else if (hour >= 12 && hour < 18) timeOfDay = '–î–µ–Ω—å';
        else if (hour >= 18 && hour < 22) timeOfDay = '–í–µ—á–µ—Ä';

        return {
            timeOfDay: timeOfDay,
            isDaytime: isDaytime,
            description: '–ü—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω–æ–µ –≤—Ä–µ–º—è'
        };
    }

    const isDaytime = now >= sunData.sunrise && now < sunData.sunset;

    let timeOfDay, description;
    if (now < sunData.sunrise) {
        timeOfDay = '–ù–æ—á—å';
        description = '–¢–µ–º–Ω–æ, –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–∞—è –≤–∏–¥–∏–º–æ—Å—Ç—å';
    } else if (now < new Date(sunData.sunrise.getTime() + 2 * 60 * 60 * 1000)) {
        timeOfDay = '–£—Ç—Ä–æ';
        description = '–ê–∫—Ç–∏–≤–Ω–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ';
    } else if (now < sunData.sunset) {
        timeOfDay = '–î–µ–Ω—å';
        description = '–í—ã—Å–æ–∫–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å';
    } else if (now < new Date(sunData.sunset.getTime() + 1 * 60 * 60 * 1000)) { // 1 —á–∞—Å –ø–æ—Å–ª–µ –∑–∞–∫–∞—Ç–∞
        timeOfDay = '–í–µ—á–µ—Ä';
        description = '–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Å–Ω–∏–∂–∞–µ—Ç—Å—è';
    } else {
        timeOfDay = '–ù–æ—á—å';
        description = '–¢–µ–º–Ω–æ, –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–∞—è –≤–∏–¥–∏–º–æ—Å—Ç—å';
    }

    return { timeOfDay, isDaytime, description };
}

// --- –†–ê–°–ß–Å–¢ –†–ò–°–ö–û–í ---
async function calculateRiskFactors(coords) {
    const [lat, lon] = coords;
    const now = new Date();
    const day = now.getDay();
    const timeInfo = await getTimeOfDayByLocation(lat, lon);

    // –í—Ä–µ–º—è —Å—É—Ç–æ–∫
    let timeRisk;
    if (timeInfo.timeOfDay === '–ù–æ—á—å') timeRisk = 75;
    else if (timeInfo.timeOfDay === '–í–µ—á–µ—Ä') timeRisk = 60;
    else if (timeInfo.timeOfDay === '–£—Ç—Ä–æ') timeRisk = 30;
    else timeRisk = 40;

    // –î–µ–Ω—å –Ω–µ–¥–µ–ª–∏
    const dayNames = ['–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ', '–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫', '–í—Ç–æ—Ä–Ω–∏–∫', '–°—Ä–µ–¥–∞', '–ß–µ—Ç–≤–µ—Ä–≥', '–ü—è—Ç–Ω–∏—Ü–∞', '–°—É–±–±–æ—Ç–∞'];
    const dayName = dayNames[day];
    let dayRisk, dayDesc;
    if (day === 0 || day === 6) { // –í—Å, –°–±
        dayRisk = 35;
        dayDesc = '–í—ã—Ö–æ–¥–Ω–æ–π –¥–µ–Ω—å';
    } else if (day === 5) { // –ü—Ç
        dayRisk = 70;
        dayDesc = '–ü—è—Ç–Ω–∏—Ü–∞ (–≤—ã—Å–æ–∫–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å)';
    } else {
        dayRisk = 55;
        dayDesc = '–ë—É–¥–Ω–∏–π –¥–µ–Ω—å';
    }

    // –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∫–æ –≤—Å–µ–º API (—Ç–µ–ø–µ—Ä—å —Ç–æ–ª—å–∫–æ –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ)
    const [noiseData, crowdData, lightData, weatherData, trafficData] = await Promise.allSettled([
        getNoiseFromOsmBased(lat, lon),         // OSM
        getCrowdFromOsmBased(lat, lon),         // OSM
        getLightFromSunriseAndOsm(lat, lon),    // Sunrise-Sunset + OSM
        getWeatherFromOpenMeteo(lat, lon),      // Open-Meteo
        getTrafficFromFallback(lat, lon)        // Fallback (–≤—Ä–µ–º—è —Å—É—Ç–æ–∫)
    ]);

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    const noise = noiseData.status === 'fulfilled' ? noiseData.value : {
        level: 45,
        risk: 30,
        desc: '–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö (Fallback)',
        source: 'fallback_error'
    };
    const crowd = crowdData.status === 'fulfilled' ? crowdData.value : {
        level: 25,
        risk: 20,
        desc: '–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö (Fallback)',
        source: 'fallback_error'
    };
    const light = lightData.status === 'fulfilled' ? lightData.value : {
        level: 25,
        risk: 70,
        desc: '–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö (Fallback)',
        source: 'fallback_error'
    };
    const weather = weatherData.status === 'fulfilled' ? weatherData.value : {
        temp: 'N/A',
        condition: '–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö',
        wind: 'N/A',
        humidity: 'N/A'
    };
    const traffic = trafficData.status === 'fulfilled' ? trafficData.value : {
        level: 5,
        status: '–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö (Fallback)',
        speed_avg: 'N/A',
        source: 'fallback_error'
    };

    // –û—Ü–µ–Ω–∫–∞ —Ä–∏—Å–∫–∞ –æ—Ç –ø—Ä–æ–±–æ–∫ (—É—Ä–æ–≤–µ–Ω—å * 10 –¥–ª—è –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è)
    const trafficRisk = traffic.level * 10;

    // –°—Ä–µ–¥–Ω–∏–π —Ä–∏—Å–∫
    const avgRisk = (noise.risk + crowd.risk + light.risk + timeRisk + dayRisk + trafficRisk) / 6;
    const safetyIndex = Math.round(100 - avgRisk);

    const result = {
        noise, crowd, light,
        time: {
            value: timeInfo.timeOfDay,
            risk: timeRisk,
            desc: timeInfo.description
        },
        day: {
            value: dayNames[day],
            risk: dayRisk,
            desc: dayDesc
        },
        traffic, weather, safetyIndex,
        timestamp: new Date().toLocaleString('ru-RU')
    };

    if (CONFIG.debugMode) console.log("Calculated Risks:", result);
    return result;
}

// --- UI –§–£–ù–ö–¶–ò–ò ---
function getRiskClass(risk) {
    if (risk < 40) return 'risk-low';
    if (risk < 70) return 'risk-medium';
    return 'risk-high';
}

function getSafetyColor(index) {
    if (index >= 70) return '#27ae60'; // Green
    if (index >= 40) return '#f39c12'; // Orange
    return '#e74c3c'; // Red
}

function getSafetyLabel(index) {
    if (index >= 80) return 'üü¢ –û—á–µ–Ω—å –±–µ–∑–æ–ø–∞—Å–Ω–æ';
    if (index >= 60) return 'üü° –ë–µ–∑–æ–ø–∞—Å–Ω–æ';
    if (index >= 40) return 'üü† –£–º–µ—Ä–µ–Ω–Ω—ã–π —Ä–∏—Å–∫';
    if (index >= 20) return 'üî¥ –ü–æ–≤—ã—à–µ–Ω–Ω—ã–π —Ä–∏—Å–∫';
    return '‚ö´ –í—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫';
}

// --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ö–ê–†–¢–´ ---
ymaps.ready(init);

function init() {
    try {
        map = new ymaps.Map('map', {
            center: CONFIG.defaultCoords,
            zoom: 13,
            controls: ['zoomControl', 'fullscreenControl', 'geolocationControl']
        });

        // --- –°–õ–û–ô –ü–†–û–ë–û–ö –Ø–ù–î–ï–ö–° (–í–°–ï–ì–î–ê –í–ö–õ–Æ–ß–Å–ù) ---
        try {
            // –°–æ–∑–¥–∞—ë–º —Å–ª–æ–π –ø—Ä–æ–±–æ–∫
            const trafficLayer = new ymaps.layer.TrafficLayer({
                trafficProvider: 'yandex#actual',
                showInScaleDependentMode: false // –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –≤—Å–µ–≥–¥–∞, –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –º–∞—Å—à—Ç–∞–±–∞
            });
            // –î–æ–±–∞–≤–ª—è–µ–º —Å–ª–æ–π –Ω–∞ –∫–∞—Ä—Ç—É
            trafficLayer.setMap(map);
            console.log("Yandex Traffic layer added and enabled.");
        } catch(e) {
            console.warn("Failed to initialize Yandex Traffic layer:", e);
            updateStatus('warning', '–ü—Ä–æ–±–∫–∏: –æ—à–∏–±–∫–∞ —Å–ª–æ—è');
        }
        // -----------------------------

        createPlacemark(CONFIG.defaultCoords);

        mapInitialized = true;
        map.events.add('click', function(e) {
            const coords = e.get('coords');
            movePlacemark(coords, true);
        });

        // –ò–Ω–∏—Ü–∏–∏—Ä—É–µ–º –∑–∞–≥—Ä—É–∑–∫—É –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –Ω–∞—á–∞–ª—å–Ω–æ–π —Ç–æ—á–∫–∏
        requestWeatherData(CONFIG.defaultCoords, true);

        document.getElementById('btn-force-refresh').addEventListener('click', forceRefresh);
    } catch (error) {
        console.error("Yandex Maps Init Error:", error);
        showMapError(error);
    }
}

function showMapError(error) {
    document.getElementById('map-error').classList.add('visible');
    console.error("Map failed to load:", error);
}

function createPlacemark(coords) {
    if (placemark) map.geoObjects.remove(placemark);

    placemark = new ymaps.Placemark(coords, {
        hintContent: 'üéØ –ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Ä–∏—Å–∫–æ–≤',
        balloonContentHeader: '–í—ã–±—Ä–∞–Ω–Ω–∞—è —Ç–æ—á–∫–∞',
        balloonContentBody: '–§–∞–∫—Ç–æ—Ä—ã —Ä–∏—Å–∫–∞ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏'
    }, {
        preset: 'islands#redStretchyIcon',
        draggable: true,
        iconColor: '#e74c3c'
    });

    placemark.events.add('dragstart', () => { isDragging = true; });
    placemark.events.add('drag', (e) => {
        const coords = placemark.geometry.getCoordinates();
        updateCoordsDisplay(coords);
        currentCoords = coords;
        throttledRequest(coords);
    });
    placemark.events.add('dragend', () => {
        isDragging = false;
        const coords = placemark.geometry.getCoordinates();
        // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø–æ—Å–ª–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
        requestWeatherData(coords, true);
    });

    map.geoObjects.add(placemark);
}

function movePlacemark(coords, forceUpdate = false) {
    if (placemark) {
        placemark.geometry.setCoordinates(coords);
    } else {
        createPlacemark(coords);
        return;
    }
    // –ü–ª–∞–≤–Ω–æ –ø–µ—Ä–µ–º–µ—â–∞–µ–º –∫–∞—Ä—Ç—É –∫ –Ω–æ–≤—ã–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º
    map.panTo(coords, { duration: 250, flying: false });
    updateCoordsDisplay(coords);
    currentCoords = coords;
    if (forceUpdate) {
        requestWeatherData(coords, true);
    } else {
        throttledRequest(coords);
    }
}

function updateCoordsDisplay(coords) {
    document.getElementById('coords-display').textContent =
        `–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ${formatCoord(coords[0])}, ${formatCoord(coords[1])}`;
}

const throttledRequest = throttle(
    (coords) => requestWeatherData(coords, false),
    CONFIG.throttleMs
);

// --- –û–°–ù–û–í–ù–û–ô –ó–ê–ü–†–û–° –î–ê–ù–ù–´–• ---
async function requestWeatherData(coords, force = false) {
    if (!force && lastRequestCoords &&
        Math.abs(coords[0] - lastRequestCoords[0]) < 0.0001 &&
        Math.abs(coords[1] - lastRequestCoords[1]) < 0.0001) {
        if (CONFIG.debugMode) console.log("Request throttled due to small coordinate change.");
        return;
    }

    showLoader(true);
    updateStatus('loading', '–ó–∞–≥—Ä—É–∑–∫–∞...'); // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å

    try {
        const risks = await calculateRiskFactors(coords);
        renderData({ risks }, coords);
        updateStatus('ok', `–î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã (${risks.timestamp})`);
        // –£–±—Ä–∞–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ demoMode, —Ç–∞–∫ –∫–∞–∫ —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ API
    } catch (err) {
        console.error("Main request error:", err);
        updateStatus('error', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
    } finally {
        showLoader(false);
    }
}

function forceRefresh() {
    apiCache.clear(); // –û—á–∏—â–∞–µ–º –∫—ç—à
    // –£–±—Ä–∞–Ω–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ demoMode
    updateStatus('loading', '–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ...');
    requestWeatherData(currentCoords, true);
}

function renderData(data, coords) {
    const w = data?.risks?.weather || {};
    const risks = data?.risks;
    const safetyIndex = risks?.safetyIndex || 0;

    // –ò–Ω–¥–µ–∫—Å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
    const safetyEl = document.getElementById('safety-index-value');
    const safetyLabel = document.getElementById('safety-index-label');
    const safetyCard = document.getElementById('safety-index-card');
    safetyEl.textContent = safetyIndex;
    safetyLabel.textContent = getSafetyLabel(safetyIndex);
    const safetyColor = getSafetyColor(safetyIndex);
    let darkColor = safetyIndex >= 70 ? '#1e8449' : safetyIndex >= 40 ? '#d35400' : '#c0392b';
    safetyCard.style.background = `linear-gradient(135deg, ${safetyColor} 0%, ${darkColor} 100%)`;
    safetyCard.style.boxShadow = '0 5px 15px rgba(0, 0, 0, 0.15)';

    // –§–∞–∫—Ç–æ—Ä—ã —Ä–∏—Å–∫–∞
    updateRiskItem('noise', risks?.noise?.level, risks?.noise?.risk, risks?.noise?.desc);
    updateRiskItem('crowd', risks?.crowd?.level, risks?.crowd?.risk, risks?.crowd?.desc);
    updateRiskItem('light', risks?.light?.level, risks?.light?.risk, risks?.light?.desc);
    updateRiskItem('time', null, risks?.time?.risk, risks?.time?.desc, risks?.time?.value);
    updateRiskItem('day', null, risks?.day?.risk, risks?.day?.desc, risks?.day?.value);

    // –ü–æ–≥–æ–¥–∞
    document.getElementById('w-temp').textContent = w.temp != null ? `${w.temp}¬∞C` : '‚Äî';
    document.getElementById('w-cond').textContent = w.condition || '‚Äî';
    document.getElementById('w-wind').textContent = w.wind || '‚Äî';
    document.getElementById('w-hum').textContent = w.humidity != null ? `${w.humidity}%` : '‚Äî';

    // –ü—Ä–æ–±–∫–∏ (—Ç–æ–ª—å–∫–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è, —Å–ª–æ–π –Ω–∞ –∫–∞—Ä—Ç–µ –æ—Ç–¥–µ–ª—å–Ω–æ)
    const t = risks?.traffic || { level: 5, status: 'N/A' };
    document.getElementById('t-level').textContent = t.level !== undefined ? `${t.level}/10` : '‚Äî';
    document.getElementById('t-status').textContent = t.status || '‚Äî';
}

function updateRiskItem(type, level, risk, desc, valueOverride = null) {
    const bar = document.getElementById(`${type}-bar`);
    const value = document.getElementById(`${type}-value`);
    const description = document.getElementById(`${type}-desc`);

    if (!bar || !value) return;

    const riskClass = getRiskClass(risk);
    bar.className = `risk-fill ${riskClass}`;
    // –ê–Ω–∏–º–∞—Ü–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —à–∏—Ä–∏–Ω—ã
    bar.style.width = '0%';
    setTimeout(() => { bar.style.width = `${risk}%`; }, 50);

    if (valueOverride !== null) {
        value.textContent = valueOverride;
    } else if (level !== null && level !== undefined) {
        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —É—Ä–æ–≤–µ–Ω—å, –µ—Å–ª–∏ –æ–Ω —á–∏—Å–ª–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
        value.textContent = typeof level === 'number' ? `${level}` : `${risk}%`;
    } else {
        // –ò–Ω–∞—á–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ä–∏—Å–∫
        value.textContent = `${risk}%`;
    }

    if (description) description.textContent = desc;
}

function showLoader(show) {
    const loader = document.getElementById('loader');
    const content = document.getElementById('content');
    loader.classList.toggle('active', show);
    content.style.opacity = show ? '0.7' : '1';
    content.style.pointerEvents = show ? 'none' : 'auto';
}

function updateStatus(state, text = '') {
    const dot = document.getElementById('server-dot');
    const txt = document.getElementById('server-text');
    dot.className = 'status-dot ' + (state === 'ok' ? 'status-good' :
                                     state === 'error' ? 'status-error' :
                                     state === 'loading' ? 'status-warning' : 'status-warning'); // loading —Ç–æ–∂–µ –∂—ë–ª—Ç—ã–π
    txt.textContent = text || (state === 'ok' ? '–û–Ω–ª–∞–π–Ω' :
                               state === 'error' ? '–û—à–∏–±–∫–∞' : '–ó–∞–≥—Ä—É–∑–∫–∞...');
}

// --- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç—ã ---
setTimeout(() => {
    if (!mapInitialized) {
        showMapError(new Error('Yandex Maps failed to initialize within 5 seconds.'));
        updateStatus('error', '–ö–∞—Ä—Ç–∞: —Ç–∞–π–º–∞—É—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏');
    }
}, 5000);

</script>
</body>
</html>
