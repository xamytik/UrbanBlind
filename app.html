<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#34495e">
<title>UrbanBlind ‚Äî –ê–Ω–∞–ª–∏–∑ —Ä–∏—Å–∫–æ–≤ –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏</title>
<style>
/* ==================== –ë–ê–ó–û–í–´–ï –°–¢–ò–õ–ò ==================== */
* { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
:root {
    --glass-bg: rgba(255, 255, 255, 0.9);
    --glass-border: rgba(0, 0, 0, 0.08);
    --glass-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    --glass-blur: blur(12px);
    --primary-color: #34495e;
    --secondary-color: #2c3e50;
    --accent-blue: #3498db;
    --accent-orange: #e67e22;
    --accent-purple: #9b59b6;
    --accent-green: #27ae60;
    --text-primary: #2c3e50;
    --text-secondary: #7f8c8d;
    --text-muted: #95a5a6;
    --noise-color: #f39c12;
    --crowd-color: #9b59b6;
    --light-color: #3498db;
    --time-color: #1abc9c;
    --day-color: #e67e22;
    --bg: #e3f2fd; /* üîµ –°–≤–µ—Ç–ª–æ-–≥–æ–ª—É–±–æ–π —Ñ–æ–Ω */
    --card-bg: #ffffff;
    --shadow: 0 2px 10px rgba(0,0,0,0.08);
    --radius: 12px;
    --success: #27ae60;
    --warning: #e67e22;
    --danger: #e74c3c;
}
body {
    display: flex;
    height: 100vh;
    overflow: hidden;
    background: var(--bg); /* üîµ –°–≤–µ—Ç–ª–æ-–≥–æ–ª—É–±–æ–π —Ñ–æ–Ω */
    width: 100vw;
    -webkit-tap-highlight-color: transparent;
}

/* ==================== –õ–û–ì–û–¢–ò–ü (DESKTOP) ==================== */
#ub-logo {
    position: fixed; top: 15px; left: 20px; font-size: 24px; font-weight: 800;
    color: white; z-index: 100; text-shadow: 0 2px 4px rgba(0,0,0,0.2);
    letter-spacing: -1px;
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    border-radius: 12px;
    padding: 8px 20px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
    border: 1px solid rgba(255, 255, 255, 0.2);
    transition: all 0.3s ease;
    display: flex; align-items: center; gap: 8px;
}
#ub-logo::before { content: 'üõ°Ô∏è'; font-size: 20px; }
#ub-logo:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2); }

/* ==================== –ö–ê–†–¢–ê ==================== */
#map { flex: 2; height: 100%; min-width: 0; position: relative; background: #e8eaed; }
#map-error {
    position: absolute; top: 0; left: 0; right: 0; bottom: 0;
    background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%);
    color: white; display: none; flex-direction: column;
    align-items: center; justify-content: center; text-align: center;
    padding: 20px; z-index: 1000; animation: fadeIn 0.5s ease;
}
#map-error.visible { display: flex; }
#map-error h2 { margin-bottom: 15px; font-size: 24px; }
#map-error p { margin-bottom: 20px; max-width: 400px; line-height: 1.6; }
#map-error button {
    padding: 12px 24px; background: rgba(255, 255, 255, 0.15);
    color: white; border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px;
    transition: all 0.3s ease;
}
#map-error button:hover { background: rgba(255, 255, 255, 0.25); transform: translateY(-2px); }

/* ==================== SIDEBAR (DESKTOP) ==================== */
#sidebar {
    flex: 1; background: var(--glass-bg); backdrop-filter: var(--glass-blur);
    -webkit-backdrop-filter: var(--glass-blur); padding: 20px;
    overflow-y: auto; box-shadow: var(--glass-shadow);
    max-width: 500px; display: flex; flex-direction: column;
    z-index: 10; min-width: 350px; position: relative;
}
.instructions-container {
    position: sticky; top: 0; z-index: 100; background: var(--glass-bg);
    backdrop-filter: var(--glass-blur); -webkit-backdrop-filter: var(--glass-blur);
    border-radius: 12px; margin: -20px -20px 20px -20px;
    padding: 15px 20px; box-shadow: var(--glass-shadow);
}
.instructions {
    background: rgba(238, 247, 255, 0.7); border-left: 4px solid var(--accent-blue);
    padding: 12px; border-radius: 0 4px 4px 0; font-size: 13px; color: var(--text-primary);
}
.instructions h3 { font-weight: 600; margin-bottom: 8px; color: var(--secondary-color); display: flex; align-items: center; gap: 8px; }
.instructions ul { padding-left: 20px; }
.instructions li { margin-bottom: 5px; line-height: 1.4; }
.sidebar-header {
    margin-bottom: 20px; padding-bottom: 15px;
    border-bottom: 1px solid var(--glass-border);
    position: sticky; top: 0; background: var(--glass-bg); z-index: 100;
}
h1 { font-size: 20px; color: var(--secondary-color); margin-bottom: 5px; font-weight: 600; }
.subtitle { color: var(--text-muted); font-size: 12px; font-weight: 500; }
.api-status {
    display: flex; align-items: center; font-size: 11px;
    color: var(--text-muted); margin-top: 12px; flex-wrap: wrap;
    gap: 8px;
    background: rgba(52, 152, 219, 0.15); /* üîµ –ì–æ–ª—É–±–æ–π —Ñ–æ–Ω —Å—Ç–∞—Ç—É—Å–∞ */
    padding: 6px 12px; border-radius: 20px;
    border: 1px solid rgba(52, 152, 219, 0.3);
}
.status-dot { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 4px; }
.status-good { background-color: var(--accent-green); box-shadow: 0 0 8px rgba(39,174,96,0.5); }
.status-warning { background-color: var(--accent-orange); box-shadow: 0 0 8px rgba(230,126,34,0.5); }
.status-error { background-color: var(--danger); box-shadow: 0 0 8px rgba(231,76,60,0.5); }
.card {
    background: #fff; border-radius: 12px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
    padding: 20px; margin-bottom: 20px; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    position: relative; overflow: hidden;
}
.card:hover { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1); }
.card-title { display: flex; align-items: center; margin-bottom: 15px; color: var(--text-primary); font-weight: 600; font-size: 18px; }
.card-title .icon { margin-right: 10px; font-size: 20px; }
.data-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid rgba(0, 0, 0, 0.05); transition: all 0.3s ease; }
.data-row:hover { background: rgba(0, 0, 0, 0.02); padding-left: 10px; }
.data-row:last-child { border-bottom: none; }
.data-label { color: var(--text-muted); font-weight: 500; }
.data-value { font-weight: 600; color: var(--text-primary); }
.safety-index { padding: 18px; border-radius: 10px; margin-bottom: 15px; position: relative; overflow: hidden; }
.safety-index-title { font-size: 13px; opacity: 0.8; margin-bottom: 5px; position: relative; z-index: 1; }
.safety-index-value { font-size: 40px; font-weight: 800; position: relative; z-index: 1; text-shadow: 0 2px 4px rgba(0,0,0,0.2); }
.safety-index-label { font-size: 12px; opacity: 0.9; margin-top: 5px; position: relative; z-index: 1; }
.risk-grid { display: grid; grid-template-columns: 1fr; gap: 15px; }
.risk-item {
    background: #fafbfc; padding: 15px; border-radius: 10px;
    border-left: 4px solid var(--glass-border);
    transition: all 0.3s ease; position: relative; overflow: hidden;
}
.risk-item:hover { transform: translateX(3px); background: #f8f9fa; }
.risk-item.noise { border-left-color: var(--noise-color); }
.risk-item.crowd { border-left-color: var(--crowd-color); }
.risk-item.light { border-left-color: var(--light-color); }
.risk-item.time { border-left-color: var(--time-color); }
.risk-item.day { border-left-color: var(--day-color); }
.risk-item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
.risk-item-title { font-weight: 600; font-size: 14px; color: var(--text-primary); }
.risk-item-icon { font-size: 18px; opacity: 0.7; }
.risk-indicator { display: flex; align-items: center; gap: 10px; margin-top: 5px; }
.risk-bar { flex: 1; height: 8px; background: rgba(0, 0, 0, 0.05); border-radius: 4px; overflow: hidden; position: relative; }
.risk-fill { height: 100%; border-radius: 4px; transition: width 0.8s cubic-bezier(0.25, 0.8, 0.25, 1), background 0.5s ease; position: relative; overflow: hidden; }
.risk-low { background: var(--accent-green); box-shadow: 0 2px 8px rgba(39, 174, 96, 0.2); }
.risk-medium { background: var(--accent-orange); box-shadow: 0 2px 8px rgba(230, 126, 34, 0.2); }
.risk-high { background: var(--danger); box-shadow: 0 2px 8px rgba(231, 76, 60, 0.2); }
.risk-value { min-width: 50px; text-align: right; font-weight: 600; font-size: 14px; color: var(--text-primary); transition: all 0.3s ease; }
.traffic-low { background: #d4edda; color: #155724; padding: 3px 8px; border-radius: 15px; font-weight: 600; font-size: 13px; display: inline-block; }
.traffic-medium { background: #fff3cd; color: #856404; padding: 3px 8px; border-radius: 15px; font-weight: 600; font-size: 13px; display: inline-block; }
.traffic-high { background: #f8d7da; color: #721c24; padding: 3px 8px; border-radius: 15px; font-weight: 600; font-size: 13px; display: inline-block; }
.loader { text-align: center; padding: 15px; color: var(--text-muted); font-style: italic; display: none; background: rgba(0, 0, 0, 0.02); border-radius: 8px; margin-bottom: 15px; }
.loader.active { display: block; }
.loader::before { content: 'üîÑ'; display: inline-block; animation: spin 1.2s linear infinite; margin-right: 8px; }
.btn-save { padding: 8px 16px; background: var(--accent-blue); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; margin-top: 12px; transition: all 0.3s ease; width: 100%; }
.btn-save:hover { background: #2980b9; transform: translateY(-1px); }
.btn-refresh { padding: 5px 10px; background: var(--accent-purple); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; margin-left: 8px; transition: all 0.2s ease; }
.btn-refresh:hover { background: #8e44ad; transform: scale(1.05); }
footer { margin-top: auto; padding-top: 15px; border-top: 1px solid var(--glass-border); font-size: 11px; color: var(--text-muted); text-align: center; }
.demo-mode-badge {
    background: #fff3cd; color: #856404; padding: 4px 8px; border-radius: 4px;
    font-size: 10px; font-weight: bold; margin-left: auto; border: 1px solid #ffeeba;
}

/* ==================== –ú–û–ë–ò–õ–¨–ù–´–ï –°–¢–ò–õ–ò ==================== */
.app-header {
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    color: white;
    padding: 12px 15px;
    display: none;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 2px 10px rgba(0,0,0,0.15);
    z-index: 100;
}
.app-title {
    font-size: 18px; font-weight: 800; letter-spacing: -0.5px;
    display: flex; align-items: center; gap: 8px;
}
.app-title::before { content: 'üõ°Ô∏è'; font-size: 20px; }
.app-status {
    display: flex; align-items: center; gap: 6px; font-size: 11px;
    background: rgba(255,255,255,0.2);
    padding: 4px 12px; border-radius: 20px;
    border: 1px solid rgba(255,255,255,0.3);
}
.app-content {
    flex: 1; overflow-y: auto; padding: 12px; padding-bottom: 80px; display: none;
    background: var(--bg); /* üîµ –°–≤–µ—Ç–ª–æ-–≥–æ–ª—É–±–æ–π —Ñ–æ–Ω */
}
.safety-card {
    background: linear-gradient(135deg, var(--success), #1abc9c);
    border-radius: var(--radius); padding: 20px; color: white;
    text-align: center; margin-bottom: 12px;
    box-shadow: 0 4px 15px rgba(39,174,96,0.3); position: relative; overflow: hidden;
}
.safety-card::before {
    content: ''; position: absolute; top: -50%; left: -50%;
    width: 200%; height: 200%;
    background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
    animation: rotate 10s linear infinite;
}
@keyframes rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
.safety-value { font-size: 48px; font-weight: 800; position: relative; z-index: 1; text-shadow: 0 2px 4px rgba(0,0,0,0.2); }
.safety-label { font-size: 13px; opacity: 0.95; margin-top: 5px; position: relative; z-index: 1; }
.safety-coords { font-size: 10px; opacity: 0.8; margin-top: 8px; position: relative; z-index: 1; }
.section-title {
    font-size: 15px; font-weight: 600; color: var(--secondary-color);
    margin: 15px 0 8px 0; display: flex; align-items: center; gap: 8px;
}
.risk-grid-mobile { display: grid; grid-template-columns: 1fr; gap: 10px; }
.risk-card {
    background: var(--card-bg); border-radius: var(--radius);
    padding: 12px; box-shadow: var(--shadow);
    border-left: 4px solid var(--accent-blue); transition: all 0.3s ease;
}
.risk-card:active { transform: scale(0.98); }
.risk-card.noise { border-left-color: var(--noise-color); }
.risk-card.crowd { border-left-color: var(--crowd-color); }
.risk-card.light { border-left-color: var(--light-color); }
.risk-card.time { border-left-color: var(--time-color); }
.risk-card.day { border-left-color: var(--day-color); }
.risk-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
.risk-title { font-size: 13px; font-weight: 600; color: var(--text); }
.risk-badge {
    font-size: 9px; background: linear-gradient(135deg, var(--success), #1abc9c);
    color: white; padding: 2px 6px; border-radius: 8px; font-weight: 600;
}
.risk-bar-container { height: 6px; background: rgba(0,0,0,0.05); border-radius: 3px; overflow: hidden; margin-bottom: 6px; }
.risk-bar { height: 100%; border-radius: 3px; transition: width 0.6s cubic-bezier(0.25, 0.8, 0.25, 1); }
.risk-footer { display: flex; justify-content: space-between; align-items: center; font-size: 11px; }
.risk-desc { color: var(--text-muted); flex: 1; }
.risk-percent { font-weight: 700; color: var(--text); min-width: 40px; text-align: right; }
.info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
.info-card { background: var(--card-bg); border-radius: var(--radius); padding: 12px; box-shadow: var(--shadow); }
.info-icon { font-size: 20px; margin-bottom: 6px; }
.info-label { font-size: 10px; color: var(--text-muted); margin-bottom: 3px; }
.info-value { font-size: 14px; font-weight: 600; color: var(--text); }
.map-container {
    height: 220px; border-radius: var(--radius); overflow: hidden;
    margin-bottom: 12px; box-shadow: var(--shadow); position: relative;
    display: none; width: 100%; /* üîµ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: –ø–æ–ª–Ω–∞—è —à–∏—Ä–∏–Ω–∞ */
}
#map-mobile { width: 100%; height: 100%; }
.map-placeholder {
    position: absolute; top: 0; left: 0; right: 0; bottom: 0;
    background: linear-gradient(135deg, #e8eaed, #d5d8dc);
    display: flex; align-items: center; justify-content: center;
    color: var(--text-muted); font-size: 14px;
}
.app-nav {
    position: fixed; bottom: 0; left: 0; right: 0;
    background: var(--card-bg); display: none;
    justify-content: space-around; padding: 8px 0;
    box-shadow: 0 -2px 10px rgba(0,0,0,0.08); z-index: 100;
    padding-bottom: max(8px, env(safe-area-inset-bottom));
}
.nav-item {
    display: flex; flex-direction: column; align-items: center; gap: 3px;
    color: var(--text-muted); font-size: 10px; padding: 4px 12px;
    border-radius: 8px; transition: all 0.2s ease; cursor: pointer;
}
.nav-item:active { transform: scale(0.95); }
.nav-item.active { color: var(--accent-blue); background: rgba(52,152,219,0.15); }
.nav-icon { font-size: 18px; }
.refresh-btn {
    background: var(--accent-blue); color: white; border: none;
    padding: 7px 14px; border-radius: 18px; font-size: 12px;
    font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 5px;
    transition: all 0.2s ease;
}
.refresh-btn:active { transform: scale(0.95); }
.page { display: none; }
.page.active { display: block; }
.saved-point {
    background: var(--card-bg); border-radius: var(--radius);
    padding: 12px; margin-bottom: 8px; box-shadow: var(--shadow);
    display: flex; justify-content: space-between; align-items: center;
}
.saved-point-info { flex: 1; }
.saved-point-name { font-weight: 600; font-size: 13px; margin-bottom: 3px; }
.saved-point-coords { font-size: 10px; color: var(--text-muted); }
.saved-point-action {
    background: var(--accent-blue); color: white; border: none;
    padding: 5px 10px; border-radius: 13px; font-size: 11px; cursor: pointer;
}
.toast {
    position: fixed; bottom: 75px; left: 50%; transform: translateX(-50%) translateY(100px);
    background: var(--secondary-color); color: white; padding: 10px 18px;
    border-radius: 22px; font-size: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    transition: all 0.3s ease; z-index: 1000; opacity: 0;
}
.toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

/* üîµ –ö–Ω–æ–ø–∫–∞ "–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ" –Ω–∞ –≥–æ–ª—É–±–æ–º —Ñ–æ–Ω–µ */
.btn-clear-points {
    background: var(--accent-blue) !important;
    color: white !important;
}
.btn-clear-points:hover { background: #2980b9 !important; }

/* ==================== –°–ö–†–û–õ–õ–ë–ê–†–´ ==================== */
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: #f1f1f1; }
::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: #a1a1a1; }

/* ==================== –ê–ù–ò–ú–ê–¶–ò–ò ==================== */
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
@keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
@keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

/* ==================== –ê–î–ê–ü–¢–ò–í (DESKTOP) ==================== */
@media (min-width: 1025px) {
    .app-header, .app-content, .map-container, .app-nav { display: none !important; }
    #sidebar, #map { display: flex !important; }
    .risk-grid { grid-template-columns: 1fr; }
}

/* ==================== –ê–î–ê–ü–¢–ò–í (MOBILE) ==================== */
@media (max-width: 1024px) {
    body { flex-direction: column; }
    #sidebar, #map { display: none !important; }
    #ub-logo { display: none; }
    .app-header, .app-content, .map-container, .app-nav { display: flex !important; }
    .map-container {
        height: 250px;
        width: 100%; /* üîµ –ü–æ–ª–Ω–∞—è —à–∏—Ä–∏–Ω–∞ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
        margin: 0 12px 12px 12px;
    }
    .safety-value { font-size: 42px; }
    .risk-grid-mobile { grid-template-columns: 1fr; }
    .app-content { padding: 12px; }
}

/* ==================== –¢–ï–ú–ù–ê–Ø –¢–ï–ú–ê ==================== */
@media (prefers-color-scheme: dark) {
    :root {
        --bg: #1a2332; --card-bg: #16213e; --text: #eaeaea; --text-muted: #a0a0a0;
    }
}
</style>
</head>
<body>

<!-- üî• –õ–û–ì–û–¢–ò–ü (Desktop) -->
<div id="ub-logo">UrbanBlind</div>

<!-- üî• –ö–ê–†–¢–ê (Desktop) -->
<div id="map">
    <div id="map-error">
        <h2>üó∫Ô∏è –ö–∞—Ä—Ç–∞ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–∞—Å—å</h2>
        <p>–í–æ–∑–º–æ–∂–Ω–æ, –ø—Ä–æ–±–ª–µ–º–∞ —Å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–æ–º.</p>
        <p><strong>–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Ü–µ–Ω—Ç—Ä–∞ –ö–∞–∑–∞–Ω–∏:</strong><br>55.7961, 49.1064</p>
        <button onclick="location.reload()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É</button>
    </div>
</div>

<!-- üî• SIDEBAR (Desktop) -->
<div id="sidebar">
    <div class="instructions-container">
        <div class="instructions">
            <h3>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é</h3>
            <ul>
                <li>üéØ <strong>–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –º–∞—Ä–∫–µ—Ä</strong> ‚Äî –¥–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤—è—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</li>
                <li>üñ±Ô∏è <strong>–ö–ª–∏–∫ –ø–æ –∫–∞—Ä—Ç–µ</strong> ‚Äî –º–≥–Ω–æ–≤–µ–Ω–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥ –∫ —Ç–æ—á–∫–µ</li>
                <li>üìä <strong>–§–∞–∫—Ç–æ—Ä—ã —Ä–∏—Å–∫–∞</strong> ‚Äî —à—É–º, –ø–ª–æ—Ç–Ω–æ—Å—Ç—å –ª—é–¥–µ–π, –æ—Å–≤–µ—â–µ–Ω–Ω–æ—Å—Ç—å</li>
                <li>üå§Ô∏è <strong>–ü–æ–≥–æ–¥–∞</strong> ‚Äî —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</li>
                <li>üö¶ <strong>–ü—Ä–æ–±–∫–∏</strong> ‚Äî –¥–∞–Ω–Ω—ã–µ –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç</li>
            </ul>
        </div>
    </div>
    <div class="sidebar-header">
        <h1>UrbanBlind</h1>
        <div class="subtitle">–§–∞–∫—Ç–æ—Ä—ã —Ä–∏—Å–∫–∞ ‚Ä¢ –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å ‚Ä¢ –ê–Ω–∞–ª–∏—Ç–∏–∫–∞</div>
        <div class="api-status">
            <span class="status-dot status-good" id="server-dot"></span>
            <span id="server-text">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</span>
            <button id="btn-force-refresh" class="btn-refresh" title="–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å">üîÑ</button>
        </div>
    </div>
    <div id="loader" class="loader">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏ —Ä–∞—Å—á—ë—Ç —Ñ–∞–∫—Ç–æ—Ä–æ–≤ —Ä–∏—Å–∫–∞...</div>
    <div id="content">
        <div class="card">
            <div class="card-title"><span class="icon">üõ°Ô∏è</span>–ò–Ω–¥–µ–∫—Å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏</div>
            <div class="safety-index" id="safety-index-card">
                <div class="safety-index-title">–û–±—â–∏–π —É—Ä–æ–≤–µ–Ω—å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏</div>
                <div class="safety-index-value" id="safety-index-value">--</div>
                <div class="safety-index-label" id="safety-index-label">–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç–µ –º–∞—Ä–∫–µ—Ä –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞</div>
            </div>
            <div class="location-info" id="coords-display">–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: 55.7961, 49.1064</div>
        </div>
        <div class="card">
            <div class="card-title"><span class="icon">‚ö†Ô∏è</span>–§–∞–∫—Ç–æ—Ä—ã —Ä–∏—Å–∫–∞</div>
            <div class="risk-grid">
                <div class="risk-item noise">
                    <div class="risk-item-header">
                        <span class="risk-item-title">üîä –®—É–º –æ–∫—Ä—É–∂–∞—é—â–µ–π —Å—Ä–µ–¥—ã</span>
                        <span class="risk-item-icon">üì¢</span>
                    </div>
                    <div class="risk-indicator">
                        <div class="risk-bar"><div class="risk-fill risk-low" id="noise-bar" style="width: 0%"></div></div>
                        <span class="risk-value" id="noise-value">--</span>
                    </div>
                    <div style="font-size:11px;color:var(--text-muted);margin-top:5px" id="noise-desc">–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è...</div>
                </div>
                <div class="risk-item crowd">
                    <div class="risk-item-header">
                        <span class="risk-item-title">üë• –ü–ª–æ—Ç–Ω–æ—Å—Ç—å –ª—é–¥–µ–π</span>
                        <span class="risk-item-icon">üö∂</span>
                    </div>
                    <div class="risk-indicator">
                        <div class="risk-bar"><div class="risk-fill risk-low" id="crowd-bar" style="width: 0%"></div></div>
                        <span class="risk-value" id="crowd-value">--</span>
                    </div>
                    <div style="font-size:11px;color:var(--text-muted);margin-top:5px" id="crowd-desc">–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è...</div>
                </div>
                <div class="risk-item light">
                    <div class="risk-item-header">
                        <span class="risk-item-title">üí° –û—Å–≤–µ—â–µ–Ω–Ω–æ—Å—Ç—å</span>
                        <span class="risk-item-icon">üåô</span>
                    </div>
                    <div class="risk-indicator">
                        <div class="risk-bar"><div class="risk-fill risk-low" id="light-bar" style="width: 0%"></div></div>
                        <span class="risk-value" id="light-value">--</span>
                    </div>
                    <div style="font-size:11px;color:var(--text-muted);margin-top:5px" id="light-desc">–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è...</div>
                </div>
                <div class="risk-item time">
                    <div class="risk-item-header">
                        <span class="risk-item-title">üïê –í—Ä–µ–º—è —Å—É—Ç–æ–∫</span>
                        <span class="risk-item-icon">‚è∞</span>
                    </div>
                    <div class="risk-indicator">
                        <div class="risk-bar"><div class="risk-fill risk-low" id="time-bar" style="width: 0%"></div></div>
                        <span class="risk-value" id="time-value">--</span>
                    </div>
                    <div style="font-size:11px;color:var(--text-muted);margin-top:5px" id="time-desc">–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è...</div>
                </div>
                <div class="risk-item day">
                    <div class="risk-item-header">
                        <span class="risk-item-title">üìÖ –î–µ–Ω—å –Ω–µ–¥–µ–ª–∏</span>
                        <span class="risk-item-icon">üìÜ</span>
                    </div>
                    <div class="risk-indicator">
                        <div class="risk-bar"><div class="risk-fill risk-low" id="day-bar" style="width: 0%"></div></div>
                        <span class="risk-value" id="day-value">--</span>
                    </div>
                    <div style="font-size:11px;color:var(--text-muted);margin-top:5px" id="day-desc">–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è...</div>
                </div>
            </div>
        </div>
        <div class="card">
            <div class="card-title"><span class="icon">üå§Ô∏è</span>–ü–æ–≥–æ–¥–∞</div>
            <div class="data-row"><span class="data-label">–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞:</span><span class="data-value" id="w-temp">‚Äî</span></div>
            <div class="data-row"><span class="data-label">–°–æ—Å—Ç–æ—è–Ω–∏–µ:</span><span class="data-value" id="w-cond">‚Äî</span></div>
            <div class="data-row"><span class="data-label">–í–µ—Ç–µ—Ä:</span><span class="data-value" id="w-wind">‚Äî</span></div>
            <div class="data-row"><span class="data-label">–í–ª–∞–∂–Ω–æ—Å—Ç—å:</span><span class="data-value" id="w-hum">‚Äî</span></div>
        </div>
        <div class="card">
            <div class="card-title"><span class="icon">üöó</span>–ü—Ä–æ–±–∫–∏</div>
            <div class="data-row"><span class="data-label">–£—Ä–æ–≤–µ–Ω—å:</span><span class="data-value" id="t-level">‚Äî</span></div>
            <div class="data-row"><span class="data-label">–°—Ç–∞—Ç—É—Å:</span><span class="data-value" id="t-status">‚Äî</span></div>
        </div>
    </div>
    <footer>
        <p>UrbanBlind ¬© 2026 | Yandex Maps ‚Ä¢ OpenStreetMap ‚Ä¢ Open-Meteo</p>
        <p style="font-size:10px;margin-top:5px;color:var(--text-muted)">–•–∞–∫–∞—Ç–æ–Ω ¬´–£–º–Ω—ã–π –≥–æ—Ä–æ–¥¬ª ‚Äî –ê–Ω–∞–ª–∏–∑ —Ñ–∞–∫—Ç–æ—Ä–æ–≤ —Ä–∏—Å–∫–∞</p>
    </footer>
</div>

<!-- üî• –ú–û–ë–ò–õ–¨–ù–´–ô HEADER -->
<header class="app-header">
    <div class="app-title">UrbanBlind</div>
    <div class="app-status">
        <span class="status-dot" id="status-dot-mobile"></span>
        <span id="status-text-mobile">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ</span>
    </div>
</header>

<!-- üî• –ú–û–ë–ò–õ–¨–ù–´–ô –ö–û–ù–¢–ï–ù–¢ -->
<main class="app-content">
    <div id="page-home" class="page active">
        <div class="map-container">
            <div id="map-mobile"></div>
            <div class="map-placeholder" id="map-placeholder">üó∫Ô∏è –ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ä—Ç—ã...</div>
        </div>
        <div class="loader" id="loader-mobile">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
        <div class="safety-card" id="safety-card-mobile">
            <div class="safety-value" id="safety-value-mobile">--</div>
            <div class="safety-label" id="safety-label-mobile">–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç–µ –º–∞—Ä–∫–µ—Ä</div>
            <div class="safety-coords" id="safety-coords-mobile">55.7961, 49.1064</div>
        </div>
        <div style="display:flex;justify-content:flex-end;margin-bottom:10px;">
            <button class="refresh-btn" id="btn-refresh-mobile"><span>üîÑ</span> –û–±–Ω–æ–≤–∏—Ç—å</button>
        </div>
        <div class="section-title">‚ö†Ô∏è –§–∞–∫—Ç–æ—Ä—ã —Ä–∏—Å–∫–∞</div>
        <div class="risk-grid-mobile">
            <div class="risk-card noise">
                <div class="risk-header">
                    <span class="risk-title">üîä –®—É–º</span>
                    <span class="risk-badge" id="noise-badge-mobile" style="display:none">API</span>
                </div>
                <div class="risk-bar-container">
                    <div class="risk-bar risk-low" id="noise-bar-mobile" style="width:0%"></div>
                </div>
                <div class="risk-footer">
                    <span class="risk-desc" id="noise-desc-mobile">‚Äî</span>
                    <span class="risk-percent" id="noise-percent-mobile">--%</span>
                </div>
            </div>
            <div class="risk-card crowd">
                <div class="risk-header"><span class="risk-title">üë• –ü–ª–æ—Ç–Ω–æ—Å—Ç—å</span></div>
                <div class="risk-bar-container">
                    <div class="risk-bar risk-low" id="crowd-bar-mobile" style="width:0%"></div>
                </div>
                <div class="risk-footer">
                    <span class="risk-desc" id="crowd-desc-mobile">‚Äî</span>
                    <span class="risk-percent" id="crowd-percent-mobile">--%</span>
                </div>
            </div>
            <div class="risk-card light">
                <div class="risk-header"><span class="risk-title">üí° –û—Å–≤–µ—â–µ–Ω–∏–µ</span></div>
                <div class="risk-bar-container">
                    <div class="risk-bar risk-low" id="light-bar-mobile" style="width:0%"></div>
                </div>
                <div class="risk-footer">
                    <span class="risk-desc" id="light-desc-mobile">‚Äî</span>
                    <span class="risk-percent" id="light-percent-mobile">--%</span>
                </div>
            </div>
            <div class="risk-card time">
                <div class="risk-header"><span class="risk-title">üïê –í—Ä–µ–º—è</span></div>
                <div class="risk-bar-container">
                    <div class="risk-bar risk-low" id="time-bar-mobile" style="width:0%"></div>
                </div>
                <div class="risk-footer">
                    <span class="risk-desc" id="time-desc-mobile">‚Äî</span>
                    <span class="risk-percent" id="time-percent-mobile">--%</span>
                </div>
            </div>
        </div>
        <div class="section-title">üå§Ô∏è –ü–æ–≥–æ–¥–∞ & üö¶ –¢—Ä–∞—Ñ–∏–∫</div>
        <div class="info-grid">
            <div class="info-card">
                <div class="info-icon">üå°Ô∏è</div>
                <div class="info-label">–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞</div>
                <div class="info-value" id="w-temp-mobile">‚Äî</div>
            </div>
            <div class="info-card">
                <div class="info-icon">üí®</div>
                <div class="info-label">–í–µ—Ç–µ—Ä</div>
                <div class="info-value" id="w-wind-mobile">‚Äî</div>
            </div>
            <div class="info-card">
                <div class="info-icon">üöó</div>
                <div class="info-label">–ü—Ä–æ–±–∫–∏</div>
                <div class="info-value" id="t-level-mobile">‚Äî</div>
            </div>
            <div class="info-card">
                <div class="info-icon">üìä</div>
                <div class="info-label">–°—Ç–∞—Ç—É—Å</div>
                <div class="info-value" id="t-status-mobile">‚Äî</div>
            </div>
        </div>
    </div>
    <div id="page-saved" class="page">
        <div class="section-title">üìå –°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ —Ç–æ—á–∫–∏</div>
        <div id="saved-list"></div>
        <button class="refresh-btn" id="btn-save-point" style="width:100%;margin-top:15px;justify-content:center;">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–µ–∫—É—â—É—é —Ç–æ—á–∫—É</button>
        <button class="refresh-btn btn-clear-points" id="btn-clear-points" style="width:100%;margin-top:10px;justify-content:center;">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ</button>
    </div>
    <div id="page-info" class="page">
        <div class="section-title">‚ÑπÔ∏è –û –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏</div>
        <div class="info-card" style="margin-bottom:15px;">
            <div class="info-label">–í–µ—Ä—Å–∏—è</div>
            <div class="info-value">1.0.0</div>
        </div>
        <div class="info-card" style="margin-bottom:15px;">
            <div class="info-label">–ò—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–∞–Ω–Ω—ã—Ö</div>
            <div class="info-value" style="font-size:13px;line-height:1.6;">
                üîä Meersens API (—à—É–º)<br>üó∫Ô∏è OpenStreetMap (–ø–ª–æ—Ç–Ω–æ—Å—Ç—å)<br>
                üå§Ô∏è Open-Meteo (–ø–æ–≥–æ–¥–∞)<br>üö¶ TomTom (—Ç—Ä–∞—Ñ–∏–∫)<br>üåÖ Sunrise-Sunset (–æ—Å–≤–µ—â–µ–Ω–∏–µ)
            </div>
        </div>
    </div>
</main>

<!-- üî• –ú–û–ë–ò–õ–¨–ù–ê–Ø –ù–ê–í–ò–ì–ê–¶–ò–Ø -->
<nav class="app-nav">
    <div class="nav-item active" data-page="home"><span class="nav-icon">üè†</span><span>–ì–ª–∞–≤–Ω–∞—è</span></div>
    <div class="nav-item" data-page="saved"><span class="nav-icon">üìå</span><span>–¢–æ—á–∫–∏</span></div>
    <div class="nav-item" data-page="info"><span class="nav-icon">‚ÑπÔ∏è</span><span>–ò–Ω—Ñ–æ</span></div>
</nav>

<!-- üî• TOAST -->
<div class="toast" id="toast"></div>

<!-- üî• YANDEX MAPS API -->
<script src="https://api-maps.yandex.ru/2.1/?apikey=c2763cd1-5a14-4131-842c-2bbd60932c52&lang=ru_RU" type="text/javascript"></script>

<script>
// ==================== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ====================
const CONFIG = {
    throttleMs: 600,
    minDragDistance: 0.001,
    defaultCoords: [55.7961, 49.1064],
    overpassUrl: 'https://overpass-api.de/api/interpreter',
    openMeteoUrl: 'https://api.open-meteo.com/v1/forecast',
    cacheDuration: 300000
};

// ==================== –û–ü–†–ï–î–ï–õ–ï–ù–ò–ï –£–°–¢–†–û–ô–°–¢–í–ê ====================
function isMobileDevice() {
    const ua = navigator.userAgent || navigator.vendor || window.opera;
    const isMobileUA = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(ua);
    const isSmallScreen = window.innerWidth <= 1024;
    const hasTouch = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
    return isMobileUA || (isSmallScreen && hasTouch);
}
const IS_MOBILE = isMobileDevice();

// ==================== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ====================
let map, placemark;
let currentCoords = [...CONFIG.defaultCoords];
let lastRequestTime = 0;
let lastRequestCoords = null;
let isDragging = false;
let pendingRequest = null;
let apiCache = new Map();
let savedPoints = JSON.parse(localStorage.getItem('urbanBlindPoints') || '[]');

// ==================== –£–¢–ò–õ–ò–¢–´ ====================
function throttle(func, limitMs) {
    return function(...args) {
        const now = Date.now();
        const coords = args[0];
        if (lastRequestCoords) {
            const dist = Math.hypot(coords[0] - lastRequestCoords[0], coords[1] - lastRequestCoords[1]);
            if (dist < CONFIG.minDragDistance && now - lastRequestTime < limitMs * 2) return;
        }
        if (now - lastRequestTime >= limitMs) {
            lastRequestTime = now;
            lastRequestCoords = [...coords];
            func.apply(this, args);
        } else {
            if (pendingRequest) clearTimeout(pendingRequest);
            pendingRequest = setTimeout(() => {
                lastRequestTime = Date.now();
                lastRequestCoords = [...coords];
                func.apply(this, args);
                pendingRequest = null;
            }, limitMs - (now - lastRequestTime));
        }
    };
}

function formatCoord(val) { return val.toFixed(4); }
function getCachedData(key) {
    const cached = apiCache.get(key);
    if (cached && Date.now() - cached.time < CONFIG.cacheDuration) return cached.data;
    return null;
}
function setCachedData(key, data) { apiCache.set(key, { data, time: Date.now() }); }

function getRiskClass(risk) {
    if (risk < 40) return 'risk-low';
    if (risk < 70) return 'risk-medium';
    return 'risk-high';
}
function getSafetyColor(index) {
    if (index >= 70) return IS_MOBILE ? 'linear-gradient(135deg, #27ae60, #1abc9c)' : '#27ae60';
    if (index >= 40) return IS_MOBILE ? 'linear-gradient(135deg, #e67e22, #f39c12)' : '#f39c12';
    return IS_MOBILE ? 'linear-gradient(135deg, #e74c3c, #c0392b)' : '#e74c3c';
}
function getSafetyLabel(index) {
    if (index >= 80) return 'üü¢ –û—á–µ–Ω—å –±–µ–∑–æ–ø–∞—Å–Ω–æ';
    if (index >= 60) return 'üü° –ë–µ–∑–æ–ø–∞—Å–Ω–æ';
    if (index >= 40) return 'üü† –£–º–µ—Ä–µ–Ω–Ω—ã–π —Ä–∏—Å–∫';
    if (index >= 20) return 'üî¥ –ü–æ–≤—ã—à–µ–Ω–Ω—ã–π —Ä–∏—Å–∫';
    return '‚ö´ –í—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫';
}

function showToast(message, duration = 2000) {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.classList.add('show');
    setTimeout(() => toast.classList.remove('show'), duration);
}

// ==================== –ü–û–ì–û–î–ê ====================
async function getWeatherFromOpenMeteo(lat, lon) {
    const cacheKey = `weather:${lat.toFixed(2)},${lon.toFixed(2)}`;
    const cached = getCachedData(cacheKey);
    if (cached) return cached;
    try {
        const url = `${CONFIG.openMeteoUrl}?latitude=${lat}&longitude=${lon}&current_weather=true&hourly=relative_humidity_2m&timezone=auto`;
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 10000);
        const response = await fetch(url, { method: 'GET', headers: { 'Accept': 'application/json' }, signal: controller.signal });
        clearTimeout(timeoutId);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        const data = await response.json();
        if (!data.current_weather) throw new Error('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –ø–æ–≥–æ–¥–µ');
        let humidity = 0;
        if (data.hourly?.time?.length) {
            const now = new Date();
            const currentHour = now.getHours();
            const index = data.hourly.time.findIndex(t => new Date(t).getHours() === currentHour);
            humidity = index !== -1 ? data.hourly.relative_humidity_2m[index] : data.hourly.relative_humidity_2m[0] || 0;
        }
        const weather = {
            temp: data.current_weather.temperature ?? 0,
            wind: `${data.current_weather.windspeed ?? 0} –º/—Å`,
            humidity: humidity,
            condition: getWeatherCondition(data.current_weather.weathercode),
            weatherCode: data.current_weather.weathercode
        };
        setCachedData(cacheKey, weather);
        return weather;
    } catch (error) {
        console.error("–û—à–∏–±–∫–∞ –ø–æ–≥–æ–¥—ã:", error);
        return { temp: 0, wind: '‚Äî', humidity: 0, condition: '–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ', error: error.message };
    }
}
function getWeatherCondition(code) {
    const conditions = {
        0: '‚òÄÔ∏è –Ø—Å–Ω–æ', 1: 'üå§Ô∏è –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–µ–Ω–Ω–æ —è—Å–Ω–æ', 2: '‚õÖ –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–±–ª–∞—á–Ω–æ—Å—Ç—å',
        3: '‚òÅÔ∏è –ü–∞—Å–º—É—Ä–Ω–æ', 45: 'üå´Ô∏è –¢—É–º–∞–Ω', 48: '‚ùÑÔ∏è –ò–Ω–µ–π',
        51: 'üíß –ú–æ—Ä–æ—Å—å', 53: 'üíß –ú–æ—Ä–æ—Å—å', 55: 'üíß –ú–æ—Ä–æ—Å—å',
        61: 'üåßÔ∏è –î–æ–∂–¥—å', 63: 'üåßÔ∏è –î–æ–∂–¥—å', 65: 'üåßÔ∏è –°–∏–ª—å–Ω—ã–π –¥–æ–∂–¥—å',
        71: '‚ùÑÔ∏è –°–Ω–µ–≥', 73: '‚ùÑÔ∏è –°–Ω–µ–≥', 75: '‚ùÑÔ∏è –°–∏–ª—å–Ω—ã–π —Å–Ω–µ–≥',
        80: 'üå¶Ô∏è –õ–∏–≤–µ–Ω—å', 81: 'üå¶Ô∏è –õ–∏–≤–µ–Ω—å', 82: 'üå¶Ô∏è –°–∏–ª—å–Ω—ã–π –ª–∏–≤–µ–Ω—å',
        95: '‚õàÔ∏è –ì—Ä–æ–∑–∞', 96: '‚õàÔ∏è –ì—Ä–æ–∑–∞ —Å –≥—Ä–∞–¥–æ–º'
    };
    return conditions[code] || '‚ùì –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
}

// ==================== –ü–†–û–ë–ö–ò ====================
async function getTrafficFromYandex(lat, lon) {
    const hour = new Date().getHours();
    let timeLevel = (hour >= 7 && hour < 10) || (hour >= 17 && hour < 20) ? 7 : (hour >= 10 && hour < 17) ? 4 : 2;
    const roadLevel = await getRoadDensity(lat, lon);
    const level = Math.min(10, Math.max(1, timeLevel + roadLevel - 3));
    return { level: level, status: level > 7 ? '–í—ã—Å–æ–∫–∞—è –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ—Å—Ç—å' : level > 4 ? '–£–º–µ—Ä–µ–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ—Å—Ç—å' : '–ù–∏–∑–∫–∞—è –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ—Å—Ç—å', source: 'yandex-time-roads' };
}
async function getRoadDensity(lat, lon) {
    const cacheKey = `roads:${lat.toFixed(4)},${lon.toFixed(4)}`;
    const cached = getCachedData(cacheKey);
    if (cached) return cached;
    const query = `[out:json][timeout:25];way(around:500,${lat},${lon})["highway"];out tags;`;
    try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 10000);
        const response = await fetch(CONFIG.overpassUrl, {
            method: 'POST', body: `data=${encodeURIComponent(query)}`,
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, signal: controller.signal
        });
        clearTimeout(timeoutId);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        const data = await response.json();
        const highways = data.elements.filter(e => e.tags?.highway);
        let busyCount = 0;
        highways.forEach(way => { if (['motorway', 'trunk', 'primary'].includes(way.tags.highway)) busyCount++; });
        let roadLevel = busyCount > 5 ? 6 : busyCount > 2 ? 4 : busyCount > 0 ? 2 : 1;
        setCachedData(cacheKey, roadLevel);
        return roadLevel;
    } catch (error) { console.error("–û—à–∏–±–∫–∞ –¥–æ—Ä–æ–≥:", error); return 3; }
}

// ==================== –®–£–ú ====================
async function getNoiseFromOSM(lat, lon) {
    const cacheKey = `noise:${lat.toFixed(4)},${lon.toFixed(4)}`;
    const cached = getCachedData(cacheKey);
    if (cached) return cached;
    const query = `[out:json][timeout:25];(node["amenity"="cafe"](around:200,${lat},${lon});node["amenity"="restaurant"](around:200,${lat},${lon});node["amenity"="bar"](around:200,${lat},${lon});node["highway"](around:150,${lat},${lon});node["railway"](around:300,${lat},${lon});node["shop"](around:150,${lat},${lon}););out count;`;
    try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 10000);
        const response = await fetch(CONFIG.overpassUrl, {
            method: 'POST', body: `data=${encodeURIComponent(query)}`,
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, signal: controller.signal
        });
        clearTimeout(timeoutId);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        const data = await response.json();
        const count = data.elements?.length || 0;
        let noiseLevel, risk, desc;
        if (count > 30) { noiseLevel = 70; risk = 75; desc = '–û—á–µ–Ω—å —à—É–º–Ω–æ: —Ü–µ–Ω—Ç—Ä/—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç'; }
        else if (count > 15) { noiseLevel = 60; risk = 55; desc = '–®—É–º–Ω–æ: –∫–æ–º–º–µ—Ä—á–µ—Å–∫–∞—è –∑–æ–Ω–∞'; }
        else if (count > 5) { noiseLevel = 50; risk = 35; desc = '–£–º–µ—Ä–µ–Ω–Ω—ã–π —à—É–º: –∂–∏–ª–∞—è –∑–æ–Ω–∞'; }
        else { noiseLevel = 40; risk = 20; desc = '–¢–∏—Ö–æ: —Å–ø–æ–∫–æ–π–Ω–∞—è –∑–æ–Ω–∞'; }
        const result = { level: noiseLevel, risk: risk, desc: desc, source: 'osm' };
        setCachedData(cacheKey, result);
        return result;
    } catch (error) { console.error("–û—à–∏–±–∫–∞ —à—É–º–∞:", error); return { level: 50, risk: 40, desc: '–î–∞–Ω–Ω—ã–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã', source: 'fallback' }; }
}

// ==================== –ü–õ–û–¢–ù–û–°–¢–¨ –õ–Æ–î–ï–ô ====================
async function getCrowdFromOSM(lat, lon) {
    const cacheKey = `crowd:${lat.toFixed(4)},${lon.toFixed(4)}`;
    const cached = getCachedData(cacheKey);
    if (cached) return cached;
    const query = `[out:json][timeout:25];(node["amenity"="cafe"](around:200,${lat},${lon});node["amenity"="restaurant"](around:200,${lat},${lon});node["shop"](around:200,${lat},${lon});node["highway"="bus_stop"](around:200,${lat},${lon});node["amenity"="school"](around:200,${lat},${lon}););out count;`;
    try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 10000);
        const response = await fetch(CONFIG.overpassUrl, {
            method: 'POST', body: `data=${encodeURIComponent(query)}`,
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, signal: controller.signal
        });
        clearTimeout(timeoutId);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        const data = await response.json();
        const count = data.elements?.length || 0;
        let level, risk, desc;
        if (count > 50) { level = 85; risk = 65; desc = '–í—ã—Å–æ–∫–∞—è –ø–ª–æ—Ç–Ω–æ—Å—Ç—å'; }
        else if (count > 25) { level = 60; risk = 45; desc = '–°—Ä–µ–¥–Ω—è—è –ø–ª–æ—Ç–Ω–æ—Å—Ç—å'; }
        else if (count > 10) { level = 35; risk = 25; desc = '–ù–∏–∑–∫–∞—è –ø–ª–æ—Ç–Ω–æ—Å—Ç—å'; }
        else { level = 15; risk = 15; desc = '–û—á–µ–Ω—å –Ω–∏–∑–∫–∞—è –ø–ª–æ—Ç–Ω–æ—Å—Ç—å'; }
        const result = { level: level, risk: risk, desc: desc, source: 'osm' };
        setCachedData(cacheKey, result);
        return result;
    } catch (error) { console.error("–û—à–∏–±–∫–∞ –ø–ª–æ—Ç–Ω–æ—Å—Ç–∏:", error); return { level: 25, risk: 20, desc: '–î–∞–Ω–Ω—ã–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã', source: 'fallback' }; }
}

// ==================== –û–°–í–ï–©–ï–ù–ù–û–°–¢–¨ ====================
async function getLightFromOSM(lat, lon) {
    const cacheKey = `light:${lat.toFixed(4)},${lon.toFixed(4)}`;
    const cached = getCachedData(cacheKey);
    if (cached) return cached;
    const timeInfo = await getTimeOfDayByLocation(lat, lon);
    if (timeInfo.isDaytime) return { level: 95, risk: 10, desc: '–ï—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ –æ—Å–≤–µ—â–µ–Ω–∏–µ (–¥–µ–Ω—å)', source: 'time' };
    const query = `[out:json][timeout:25];(node["highway"="street_lamp"](around:200,${lat},${lon});node["man_made"="street_lamp"](around:200,${lat},${lon}););out count;`;
    try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 10000);
        const response = await fetch(CONFIG.overpassUrl, {
            method: 'POST', body: `data=${encodeURIComponent(query)}`,
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, signal: controller.signal
        });
        clearTimeout(timeoutId);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        const data = await response.json();
        const count = data.elements?.length || 0;
        let level, risk, desc;
        if (count > 15) { level = 75; risk = 25; desc = '–•–æ—Ä–æ—à–µ–µ –æ—Å–≤–µ—â–µ–Ω–∏–µ'; }
        else if (count > 5) { level = 50; risk = 45; desc = '–°—Ä–µ–¥–Ω–µ–µ –æ—Å–≤–µ—â–µ–Ω–∏–µ'; }
        else { level = 25; risk = 70; desc = '–°–ª–∞–±–æ–µ –æ—Å–≤–µ—â–µ–Ω–∏–µ'; }
        const result = { level: level, risk: risk, desc: desc, source: 'osm' };
        setCachedData(cacheKey, result);
        return result;
    } catch (error) { console.error("–û—à–∏–±–∫–∞ –æ—Å–≤–µ—â–µ–Ω–Ω–æ—Å—Ç–∏:", error); return { level: 30, risk: 60, desc: '–î–∞–Ω–Ω—ã–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã', source: 'fallback' }; }
}

// ==================== –í–†–ï–ú–Ø –°–£–¢–û–ö ====================
async function getSunriseSunset(lat, lon) {
    const cacheKey = `sunrise:${lat.toFixed(4)},${lon.toFixed(4)}`;
    const cached = getCachedData(cacheKey);
    if (cached) return cached;
    try {
        const url = `https://api.sunrise-sunset.org/json?lat=${lat}&lng=${lon}&date=today&formatted=0`;
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 5000);
        const response = await fetch(url, { signal: controller.signal });
        clearTimeout(timeoutId);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        const data = await response.json();
        if (!data.results?.sunrise) throw new Error('Invalid response');
        const result = { sunrise: new Date(data.results.sunrise), sunset: new Date(data.results.sunset) };
        setCachedData(cacheKey, result);
        return result;
    } catch (error) { console.error("–û—à–∏–±–∫–∞ –≤–æ—Å—Ö–æ–¥–∞/–∑–∞–∫–∞—Ç–∞:", error); return null; }
}
async function getTimeOfDayByLocation(lat, lon) {
    const now = new Date();
    const sunData = await getSunriseSunset(lat, lon);
    const hour = now.getHours();
    if (!sunData) {
        return {
            timeOfDay: hour >= 6 && hour < 12 ? '–£—Ç—Ä–æ' : hour >= 12 && hour < 18 ? '–î–µ–Ω—å' : hour >= 18 && hour < 23 ? '–í–µ—á–µ—Ä' : '–ù–æ—á—å',
            isDaytime: hour >= 6 && hour < 22, description: '–õ–æ–∫–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è'
        };
    }
    const isDaytime = now >= sunData.sunrise && now < sunData.sunset;
    let timeOfDay, description;
    if (now < sunData.sunrise) { timeOfDay = '–ù–æ—á—å'; description = '–¢–µ–º–Ω–æ'; }
    else if (now < new Date(sunData.sunrise.getTime() + 2 * 60 * 60 * 1000)) { timeOfDay = '–£—Ç—Ä–æ'; description = '–ê–∫—Ç–∏–≤–Ω–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ'; }
    else if (now < sunData.sunset) { timeOfDay = '–î–µ–Ω—å'; description = '–í—ã—Å–æ–∫–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å'; }
    else if (now < sunData.civil_twilight_end) { timeOfDay = '–í–µ—á–µ—Ä'; description = '–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Å–Ω–∏–∂–∞–µ—Ç—Å—è'; }
    else { timeOfDay = '–ù–æ—á—å'; description = '–¢–µ–º–Ω–æ'; }
    return { timeOfDay, isDaytime, description };
}

// ==================== –†–ê–°–ß–ï–¢ –†–ò–°–ö–û–í ====================
async function calculateRiskFactors(coords) {
    const [lat, lon] = coords;
    const now = new Date();
    const day = now.getDay();
    const timeInfo = await getTimeOfDayByLocation(lat, lon);
    let timeRisk = timeInfo.timeOfDay === '–ù–æ—á—å' ? 75 : timeInfo.timeOfDay === '–í–µ—á–µ—Ä' ? 60 : timeInfo.timeOfDay === '–£—Ç—Ä–æ' ? 30 : 40;
    const dayNames = ['–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ', '–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫', '–í—Ç–æ—Ä–Ω–∏–∫', '–°—Ä–µ–¥–∞', '–ß–µ—Ç–≤–µ—Ä–≥', '–ü—è—Ç–Ω–∏—Ü–∞', '–°—É–±–±–æ—Ç–∞'];
    const dayName = dayNames[day];
    let dayRisk = day === 0 || day === 6 ? 35 : day === 5 ? 70 : 55;
    let dayDesc = day === 0 || day === 6 ? '–í—ã—Ö–æ–¥–Ω–æ–π –¥–µ–Ω—å' : day === 5 ? '–ü—è—Ç–Ω–∏—Ü–∞' : '–ë—É–¥–Ω–∏–π –¥–µ–Ω—å';
    const [noiseData, crowdData, lightData, weatherData, trafficData] = await Promise.allSettled([
        getNoiseFromOSM(lat, lon), getCrowdFromOSM(lat, lon), getLightFromOSM(lat, lon),
        getWeatherFromOpenMeteo(lat, lon), getTrafficFromYandex(lat, lon)
    ]);
    const noise = noiseData.status === 'fulfilled' ? noiseData.value : { level: 45, risk: 30, desc: '–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ' };
    const crowd = crowdData.status === 'fulfilled' ? crowdData.value : { level: 25, risk: 20, desc: '–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ' };
    const light = lightData.status === 'fulfilled' ? lightData.value : { level: 25, risk: 70, desc: '–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ' };
    const weather = weatherData.status === 'fulfilled' ? weatherData.value : { temp: 0, condition: '–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ', wind: '‚Äî', humidity: 0 };
    const traffic = trafficData.status === 'fulfilled' ? trafficData.value : { level: 5, status: '–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ' };
    const trafficRisk = traffic.level * 10;
    const avgRisk = (noise.risk + crowd.risk + light.risk + timeRisk + dayRisk + trafficRisk) / 6;
    const safetyIndex = Math.round(100 - avgRisk);
    return { noise, crowd, light, time: { value: timeInfo.timeOfDay, risk: timeRisk, desc: timeInfo.description },
        day: { value: dayNames[day], risk: dayRisk, desc: dayDesc }, traffic, weather, safetyIndex, timestamp: new Date().toLocaleString('ru') };
}

// ==================== UI –§–£–ù–ö–¶–ò–ò ====================
function updateRiskItem(type, level, risk, desc, valueOverride = null, isMobile = false) {
    const prefix = isMobile ? `${type}-mobile` : type;
    const bar = document.getElementById(`${prefix}-bar`);
    const percent = document.getElementById(`${prefix}-percent`);
    const descEl = document.getElementById(`${prefix}-desc`);
    if (!bar) return;
    const riskClass = getRiskClass(risk);
    bar.className = `risk-bar ${riskClass}`;
    setTimeout(() => { bar.style.width = `${risk}%`; }, 100);
    if (percent) percent.textContent = `${risk}%`;
    if (descEl) descEl.textContent = desc || '‚Äî';
}

function renderData(data, coords, isMobile = false) {
    const w = data?.risks?.weather || {};
    const risks = data?.risks;
    const safetyIndex = risks?.safetyIndex || 0;
    const prefix = isMobile ? '-mobile' : '';

    const safetyEl = document.getElementById(`safety-value${prefix}`);
    const safetyLabel = document.getElementById(`safety-label${prefix}`);
    const safetyCard = document.getElementById(`safety-card${prefix}`);

    if (safetyEl) {
        safetyEl.textContent = safetyIndex;
        safetyEl.style.color = 'white';
    }
    if (safetyLabel) safetyLabel.textContent = getSafetyLabel(safetyIndex);
    if (safetyCard) {
        const safetyColor = getSafetyColor(safetyIndex);
        safetyCard.style.background = safetyColor;
        safetyCard.style.boxShadow = '0 5px 15px rgba(0, 0, 0, 0.15)';
    }

    // üîµ –û–±–Ω–æ–≤–ª—è–µ–º —Ñ–∞–∫—Ç–æ—Ä—ã —Ä–∏—Å–∫–∞ –¥–ª—è –ú–û–ë–ò–õ–¨–ù–û–ô –≤–µ—Ä—Å–∏–∏
    if (isMobile) {
        updateRiskItem('noise', risks?.noise?.level, risks?.noise?.risk, risks?.noise?.desc, null, true);
        updateRiskItem('crowd', risks?.crowd?.level, risks?.crowd?.risk, risks?.crowd?.desc, null, true);
        updateRiskItem('light', risks?.light?.level, risks?.light?.risk, risks?.light?.desc, null, true);
        updateRiskItem('time', null, risks?.time?.risk, risks?.time?.desc, risks?.time?.value, true);

        if (w.temp != null) document.getElementById('w-temp-mobile').textContent = `${w.temp}¬∞C`;
        if (w.wind) document.getElementById('w-wind-mobile').textContent = w.wind;
        const t = risks?.traffic || { level: 5, status: '–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ' };
        if (t.level !== undefined) document.getElementById('t-level-mobile').textContent = `${t.level}/10`;
        if (t.status) document.getElementById('t-status-mobile').textContent = t.status;
    }
    // Desktop –≤–µ—Ä—Å–∏—è
    else {
        updateRiskItem('noise', risks?.noise?.level, risks?.noise?.risk, risks?.noise?.desc, null, false);
        updateRiskItem('crowd', risks?.crowd?.level, risks?.crowd?.risk, risks?.crowd?.desc, null, false);
        updateRiskItem('light', risks?.light?.level, risks?.light?.risk, risks?.light?.desc, null, false);
        updateRiskItem('time', null, risks?.time?.risk, risks?.time?.desc, risks?.time?.value, false);

        if (w.temp != null) document.getElementById('w-temp').textContent = `${w.temp}¬∞C`;
        if (w.condition) document.getElementById('w-cond').textContent = w.condition;
        if (w.wind) document.getElementById('w-wind').textContent = w.wind;
        if (w.humidity != null) document.getElementById('w-hum').textContent = `${w.humidity}%`;
        const t = risks?.traffic || { level: 5, status: '–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ' };
        if (t.level !== undefined) document.getElementById('t-level').textContent = `${t.level}/10`;
        if (t.status) document.getElementById('t-status').textContent = t.status;
    }
}

function showLoader(show, isMobile = false) {
    const loader = document.getElementById(isMobile ? 'loader-mobile' : 'loader');
    const content = document.getElementById(isMobile ? 'page-home' : 'content');
    if (loader) loader.classList.toggle('active', show);
    if (content) {
        content.style.opacity = show ? '0.7' : '1';
        content.style.pointerEvents = show ? 'none' : 'auto';
    }
}

function updateStatus(state, text = '', isMobile = false) {
    const dot = document.getElementById(isMobile ? 'status-dot-mobile' : 'server-dot');
    const txt = document.getElementById(isMobile ? 'status-text-mobile' : 'server-text');
    if (!dot || !txt) return;
    dot.className = 'status-dot ' + (state === 'ok' ? 'status-good' : state === 'error' ? 'status-error' : 'status-warning');
    txt.textContent = text || (state === 'ok' ? '–û–Ω–ª–∞–π–Ω' : state === 'error' ? '–û—à–∏–±–∫–∞' : '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...');
}

// ==================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ö–ê–†–¢–´ ====================
function initMap() {
    try {
        const mapElementId = IS_MOBILE ? 'map-mobile' : 'map';
        const container = document.getElementById(mapElementId);
        if (!container) return;

        map = new ymaps.Map(mapElementId, {
            center: CONFIG.defaultCoords,
            zoom: IS_MOBILE ? 14 : 13,
            controls: IS_MOBILE ? ['zoomControl'] : ['zoomControl', 'fullscreenControl', 'geolocationControl']
        });

        if (!IS_MOBILE) {
            try { new ymaps.layer.TrafficLayer({ trafficProvider: 'yandex#actual' }).setMap(map); }
            catch(e) { console.warn("–ü—Ä–æ–±–∫–∏ –Ø–Ω–¥–µ–∫—Å–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã:", e); }
        }

        createPlacemark(CONFIG.defaultCoords);

        map.events.add('click', function(e) {
            const coords = e.get('coords');
            movePlacemark(coords, true);
        });

        if (IS_MOBILE) {
            document.getElementById('map-placeholder').style.display = 'none';
            requestData(CONFIG.defaultCoords, true, true);
        } else {
            requestWeatherData(CONFIG.defaultCoords, true);
            document.getElementById('btn-force-refresh').addEventListener('click', forceRefresh);
        }

    } catch (error) {
        console.error('Map error:', error);
        if (IS_MOBILE) {
            document.getElementById('map-placeholder').textContent = '‚ùå –û—à–∏–±–∫–∞ –∫–∞—Ä—Ç—ã';
        } else {
            document.getElementById('map-error').classList.add('visible');
        }
    }
}

function createPlacemark(coords) {
    if (placemark) map.geoObjects.remove(placemark);
    placemark = new ymaps.Placemark(coords, {
        hintContent: 'üéØ –ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Ä–∏—Å–∫–æ–≤',
        balloonContentHeader: '–í—ã–±—Ä–∞–Ω–Ω–∞—è —Ç–æ—á–∫–∞',
        balloonContentBody: '–§–∞–∫—Ç–æ—Ä—ã —Ä–∏—Å–∫–∞ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏'
    }, {
        preset: IS_MOBILE ? 'islands#redIcon' : 'islands#redStretchyIcon',
        draggable: true,
        iconColor: '#e74c3c'
    });

    placemark.events.add('dragstart', () => { isDragging = true; });
    placemark.events.add('drag', (e) => {
        const coords = placemark.geometry.getCoordinates();
        updateCoordsDisplay(coords);
        currentCoords = coords;
        throttledRequest(coords);
    });
    placemark.events.add('dragend', () => {
        isDragging = false;
        const coords = placemark.geometry.getCoordinates();
        if (IS_MOBILE) requestData(coords, true, true);
        else requestWeatherData(coords, true);
    });

    map.geoObjects.add(placemark);
}

function movePlacemark(coords, forceUpdate = false) {
    if (placemark) {
        placemark.geometry.setCoordinates(coords);
    } else {
        createPlacemark(coords);
        return;
    }
    map.panTo(coords, { duration: 250, flying: true });
    updateCoordsDisplay(coords);
    currentCoords = coords;
    if (forceUpdate) {
        if (IS_MOBILE) requestData(coords, true, true);
        else requestWeatherData(coords, true);
    } else {
        throttledRequest(coords);
    }
}

function updateCoordsDisplay(coords) {
    const coordText = `–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ${formatCoord(coords[0])}, ${formatCoord(coords[1])}`;
    if (!IS_MOBILE) {
        document.getElementById('coords-display').textContent = coordText;
    }
    if (IS_MOBILE) {
        document.getElementById('safety-coords-mobile').textContent = `${coords[0].toFixed(4)}, ${coords[1].toFixed(4)}`;
    }
}

const throttledRequest = throttle((coords) => {
    if (IS_MOBILE) requestData(coords, false, true);
    else requestWeatherData(coords, false);
}, CONFIG.throttleMs);

// ==================== –ó–ê–ü–†–û–° –î–ê–ù–ù–´–• ====================
async function requestWeatherData(coords, force = false) {
    if (!force && lastRequestCoords &&
        Math.abs(coords[0] - lastRequestCoords[0]) < 0.0001 &&
        Math.abs(coords[1] - lastRequestCoords[1]) < 0.0001) { return; }
    showLoader(true, false);
    try {
        const risks = await calculateRiskFactors(coords);
        renderData({ risks }, coords, false);
        updateStatus('ok', '–î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã', false);
    } catch (err) {
        console.error("–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞:", err);
        updateStatus('warning', '–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è', false);
    } finally { showLoader(false, false); }
}

async function requestData(coords, force = false, isMobile = false) {
    if (!force && lastRequestCoords &&
        Math.abs(coords[0] - lastRequestCoords[0]) < 0.0001 &&
        Math.abs(coords[1] - lastRequestCoords[1]) < 0.0001) { return; }
    showLoader(true, true);
    try {
        const risks = await calculateRiskFactors(coords);
        renderData({ risks }, coords, true);
        updateStatus('ok', '', true);
    } catch (err) {
        console.error("–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞:", err);
        updateStatus('error', '', true);
        if (document.getElementById('safety-value-mobile')) {
            document.getElementById('safety-value-mobile').textContent = 'ERR';
        }
        showToast('‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
    } finally { showLoader(false, true); }
}

function forceRefresh() {
    apiCache.clear();
    requestWeatherData(currentCoords, true);
}

// ==================== –ú–û–ë–ò–õ–¨–ù–ê–Ø –ù–ê–í–ò–ì–ê–¶–ò–Ø ====================
if (IS_MOBILE) {
    document.querySelectorAll('.nav-item').forEach(item => {
        item.addEventListener('click', () => {
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            item.classList.add('active');
            const page = item.dataset.page;
            document.getElementById(`page-${page}`).classList.add('active');
            if (page === 'saved') renderSavedPoints();
        });
    });

    document.getElementById('btn-save-point')?.addEventListener('click', () => {
        const name = prompt('üìå –ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ—á–∫–∏:', `–¢–æ—á–∫–∞ #${savedPoints.length + 1}`);
        if (!name?.trim()) return;
        const point = { id: Date.now(), name: name.trim(), coords: [...currentCoords], saved: new Date().toISOString() };
        savedPoints.unshift(point);
        localStorage.setItem('urbanBlindPoints', JSON.stringify(savedPoints));
        renderSavedPoints();
        showToast('‚úÖ –¢–æ—á–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞');
    });

    document.getElementById('btn-clear-points')?.addEventListener('click', () => {
        if (!savedPoints.length || !confirm('üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤—Å–µ —Ç–æ—á–∫–∏?')) return;
        savedPoints = [];
        localStorage.removeItem('urbanBlindPoints');
        renderSavedPoints();
        showToast('üóëÔ∏è –í—Å–µ —Ç–æ—á–∫–∏ —É–¥–∞–ª–µ–Ω—ã');
    });

    document.getElementById('btn-refresh-mobile')?.addEventListener('click', () => {
        apiCache.clear();
        requestData(currentCoords, true, true);
        showToast('üîÑ –î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã');
    });
}

function renderSavedPoints() {
    const list = document.getElementById('saved-list');
    if (!list) return;
    if (savedPoints.length === 0) {
        list.innerHTML = '<div style="text-align:center;color:var(--text-muted);padding:20px;">–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö —Ç–æ—á–µ–∫</div>';
        return;
    }
    list.innerHTML = savedPoints.map(p => `
        <div class="saved-point">
            <div class="saved-point-info">
                <div class="saved-point-name">${p.name}</div>
                <div class="saved-point-coords">${p.coords[0].toFixed(4)}, ${p.coords[1].toFixed(4)}</div>
            </div>
            <button class="saved-point-action" onclick="goToPoint(${p.id})">üìç</button>
        </div>
    `).join('');
}

window.goToPoint = function(id) {
    const p = savedPoints.find(x => x.id === id);
    if (!p) return;
    placemark.geometry.setCoordinates(p.coords);
    currentCoords = p.coords;
    map.setCenter(p.coords, 14);
    if (IS_MOBILE) requestData(p.coords, true, true);
    else requestWeatherData(p.coords, true);

    if (IS_MOBILE) {
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.querySelector('[data-page="home"]').classList.add('active');
        document.getElementById('page-home').classList.add('active');
    }
    showToast('üìç –ü–µ—Ä–µ—Ö–æ–¥ –∫ —Ç–æ—á–∫–µ');
};

// ==================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ====================
ymaps.ready(function() {
    initMap();
    if (!IS_MOBILE) {
        setTimeout(() => {
            if (!map) {
                document.getElementById('map-error').classList.add('visible');
            }
        }, 5000);
    }
});

// ==================== SERVICE WORKER ====================
if ('serviceWorker' in navigator && IS_MOBILE) {
    // navigator.serviceWorker.register('sw.js').catch(() => {});
}
</script>
</body>
</html>
